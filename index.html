<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Bulb Cafe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- QR Code Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
    <!-- Supabase Client -->
    <!-- FIX: Moved Supabase script to head to load first -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --brand-color: #F59E0B; /* Bulb Yellow */
            --brand-dark: #92400E;
        }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #1a1a2e; /* Dark blue background */
        }
        .brand-text { color: var(--brand-color); }
        .brand-bg { background-color: var(--brand-color); }
        .brand-border { border-color: var(--brand-color); }
        .hover-brand-bg:hover { background-color: var(--brand-dark); }
        .sidebar-icon {
            transition: all 0.3s ease;
        }
        .sidebar-icon:hover {
            background-color: var(--brand-color);
            color: #1a1a2e;
        }
        .modal-content {
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid var(--brand-color);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-[#1a1a2e] text-gray-100 flex h-screen overflow-hidden">

    <!-- Notification Audio -->
    <audio id="notification-sound" src="https://vrvlvvlfzbdqwfsdlrkv.supabase.co/storage/v1/object/public/video/new-notification-022-370046.mp3" preload="auto"></audio>

    <!-- Login Screen -->
    <div id="login-screen" class="w-full h-full flex items-center justify-center">
        <div class="bg-[#1e1e3f] p-8 rounded-lg shadow-xl w-full max-w-sm">
            <h1 class="text-3xl font-bold text-center brand-text mb-6">Admin Panel</h1>
            <div id="login-error" class="text-red-400 text-sm mb-4 hidden"></div>
            <div class="space-y-4">
                <input id="email-input" type="email" placeholder="Email" class="w-full p-3 bg-[#2a2a4e] rounded border border-gray-700 focus:outline-none focus:border-amber-500">
                <input id="password-input" type="password" placeholder="Password" class="w-full p-3 bg-[#2a2a4e] rounded border border-gray-700 focus:outline-none focus:border-amber-500">
                <button id="login-button" class="w-full p-3 brand-bg text-gray-900 font-bold rounded hover-brand-bg transition-colors">Login</button>
            </div>
        </div>
    </div>

    <!-- Main App (Hidden by default) -->
    <div id="admin-app" class="hidden flex w-full h-full">
        <!-- Sidebar -->
        <nav class="w-20 bg-[#1e1e3f] flex flex-col items-center py-4 space-y-4 shadow-lg">
            <div class="text-2xl font-bold brand-text">üí°</div>
            <button class="sidebar-icon p-3 rounded-lg" data-page="dashboard" title="Dashboard">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h12a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V6z" /></svg>
            </button>
            <button class="sidebar-icon p-3 rounded-lg" data-page="menu" title="Menu">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>
            </button>
            <button class="sidebar-icon p-3 rounded-lg" data-page="tables" title="Tables">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v2a2 2 0 01-2 2h-4m-12 0h4m-4 0a2 2 0 00-2 2v2a2 2 0 002 2h12a2 2 0 002-2v-2a2 2 0 00-2-2h-4m-6-6V4a2 2 0 012-2h4a2 2 0 012 2v4" /></svg>
            </button>
            <button class="sidebar-icon p-3 rounded-lg" data-page="customers" title="Customers">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 016-6h6v6z" /></svg>
            </button>
            <button class="sidebar-icon p-3 rounded-lg" data-page="qr" title="QR Generator">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v1m6 11h2m-6 6v1m-6-4h.01M5 12H3m18 0h-2M5 12h.01M12 5h.01M12 3v1m0 16v1m-6-3h.01M19 12h-2M19 12h.01M12 19h.01" /></svg>
            </button>
            <button id="logout-button" class="sidebar-icon p-3 rounded-lg mt-auto" title="Logout">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
            </button>
        </nav>

        <!-- Main Content -->
        <main class="flex-1 h-full overflow-y-auto">
            <div id="page-content" class="p-6">
                <!-- Content will be injected here -->
            </div>
        </main>
    </div>

    <!-- Modal Container -->
    <div id="modal-container" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
        <!-- Modal content will be injected here -->
    </div>

    <script type="module">
        // --- SUPABASE CONFIG ---
        const SUPABASE_URL = 'https://vrvlvvlfzbdqwfsdlrkv.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIZXV...'; // Key redacted for brevity in diff

        // FIX: Replaced destructuring with a robust check to prevent crash
        const createClient = window.supabase ? window.supabase.createClient : null;
        
        if (!createClient) {
            alert("CRITICAL: Supabase client library not found. The app cannot start. Please refresh.");
            // Stop further execution
            throw new Error("Supabase client not loaded");
        }
        
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- STATE ---
        let state = {
            products: [],
            orders: [],
            tables: [],
            customers: [],
            staffCalls: [],
            orderSubscription: null,
            callSubscription: null,
            user: null,
            audioContext: null,
            notificationSound: null
        };

        // --- DOM SELECTORS ---
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);

        // --- NOTIFICATION SOUND ---
        const notificationAudio = $("#notification-sound");

        async function initAudio() {
            if (state.audioContext) return;
            try {
                state.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                // Resume context on user gesture
                const resumeAudio = () => {
                    if (state.audioContext.state === 'suspended') {
                        state.audioContext.resume();
                    }
                    document.removeEventListener('click', resumeAudio);
                };
                document.addEventListener('click', resumeAudio);

                // Load the sound
                notificationAudio.play().catch(e => console.warn("Audio autoplay blocked. Waiting for user interaction."));
                notificationAudio.pause(); // Stop it immediately, we just want it loaded
            } catch (e) {
                console.error("Failed to initialize Web Audio API:", e);
            }
        }

        function playNotification() {
            if (!state.audioContext) {
                initAudio().then(() => {
                    notificationAudio.play().catch(e => console.error("Error playing notification:", e));
                });
            } else {
                if (state.audioContext.state === 'suspended') {
                    state.audioContext.resume();
                }
                notificationAudio.currentTime = 0;
                notificationAudio.play().catch(e => console.error("Error playing notification:", e));
            }
        }

        // --- AUTH ---
        $("#login-button").addEventListener("click", handleLogin);
        $("#logout-button").addEventListener("click", handleLogout);

        async function handleLogin() {
            const email = $("#email-input").value;
            const password = $("#password-input").value;
            const errorDiv = $("#login-error");

            try {
                const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) throw error;
                
                state.user = data.user;
                $("#login-screen").classList.add("hidden");
                $("#admin-app").classList.remove("hidden");
                initializeApp();
            } catch (error) {
                console.error("Login failed:", error);
                errorDiv.textContent = error.message;
                errorDiv.classList.remove("hidden");
            }
        }

        async function handleLogout() {
            await supabase.auth.signOut();
            state = { ...state, user: null, products: [], orders: [], tables: [], customers: [], staffCalls: [] }; // Reset state
            if (state.orderSubscription) state.orderSubscription.unsubscribe();
            if (state.callSubscription) state.callSubscription.unsubscribe();
            
            $("#login-screen").classList.remove("hidden");
            $("#admin-app").classList.add("hidden");
        }

        async function checkSession() {
            const { data } = await supabase.auth.getSession();
            if (data.session) {
                state.user = data.session.user;
                $("#login-screen").classList.add("hidden");
                $("#admin-app").classList.remove("hidden");
                initializeApp();
            }
        }

        // --- APP INITIALIZATION ---
        async function initializeApp() {
            // Add click listener for audio
            document.addEventListener('click', initAudio, { once: true });

            navigateTo("dashboard");
            setupEventListeners();
            fetchAllData();
            setupRealtimeSubscriptions();
        }

        function setupEventListeners() {
            $$(".sidebar-icon").forEach(button => {
                button.addEventListener("click", () => {
                    navigateTo(button.dataset.page);
                });
            });
        }

        async function fetchAllData() {
            try {
                const [
                    productsRes,
                    ordersRes,
                    tablesRes,
                    customersRes,
                    staffCallsRes
                ] = await Promise.all([
                    supabase.from('products').select('*').order('id'),
                    supabase.from('orders').select('*, order_items(*, products(name)), tables(table_number), customers(name)').order('created_at', { ascending: false }),
                    supabase.from('tables').select('*').order('table_number'),
                    supabase.from('customers').select('*').order('name'),
                    supabase.from('staff_calls').select('*').eq('status', 'pending').order('created_at', { ascending: false })
                ]);

                if (productsRes.error) throw new Error(`Products: ${productsRes.error.message}`);
                if (ordersRes.error) throw new Error(`Orders: ${ordersRes.error.message}`);
                if (tablesRes.error) throw new Error(`Tables: ${tablesRes.error.message}`);
                if (customersRes.error) throw new Error(`Customers: ${customersRes.error.message}`);
                if (staffCallsRes.error) throw new Error(`Staff Calls: ${staffCallsRes.error.message}`);

                state.products = productsRes.data;
                state.orders = ordersRes.data;
                state.tables = tablesRes.data;
                state.customers = customersRes.data;
                state.staffCalls = staffCallsRes.data;

                // We are already on a page, so re-render it with the new data
                const currentPage = $("#page-content").dataset.page;
                if (currentPage) {
                    renderPage(currentPage);
                }

            } catch (error) {
                console.error("Error Loading Data:", error);
                renderError("Error Loading Data", `Message: ${error.message} \nThis is likely an RLS (Row Level Security) issue. \nYour RLS policies are probably blocking this admin account from viewing all data. You must update your policies in the Supabase dashboard to grant full access to this logged-in user.`);
            }
        }

        function setupRealtimeSubscriptions() {
            // --- ORDERS SUBSCRIPTION ---
            if (state.orderSubscription) state.orderSubscription.unsubscribe();
            state.orderSubscription = supabase
                .channel('public:orders')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'orders' }, async (payload) => {
                    console.log('Order change detected:', payload);
                    // This is a simple but effective way to ensure data consistency
                    // For a high-traffic app, you'd merge the payload (payload.new)
                    await fetchAllData();
                    renderPage('dashboard');
                })
                .subscribe();

            // --- STAFF CALLS SUBSCRIPTION ---
            if (state.callSubscription) state.callSubscription.unsubscribe();
            state.callSubscription = supabase
                .channel('public:staff_calls')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'staff_calls' }, (payload) => {
                    console.log('New staff call:', payload);
                    const newCall = payload.new;
                    if (newCall.status === 'pending') {
                        playNotification();
                        state.staffCalls = [newCall, ...state.staffCalls];
                        renderDashboard(); // Re-render the dashboard
                    }
                })
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'staff_calls' }, (payload) => {
                    // Remove the call from the list if it's no longer pending
                    state.staffCalls = state.staffCalls.filter(call => call.id !== payload.new.id || payload.new.status === 'pending');
                    renderDashboard(); // Re-render the dashboard
                })
                .subscribe();
        }

        // --- NAVIGATION ---
        function navigateTo(page) {
            renderPage(page);
            // Update active sidebar icon
            $$(".sidebar-icon").forEach(btn => {
                btn.classList.toggle("bg-gray-700", btn.dataset.page === page);
                btn.classList.toggle("brand-text", btn.dataset.page === page);
            });
        }

        // --- PAGE RENDERING ---
        function renderPage(page) {
            $("#page-content").dataset.page = page;
            switch (page) {
                case 'dashboard':
                    renderDashboard();
                    break;
                case 'menu':
                    renderMenu();
                    break;
                case 'tables':
                    renderTables();
                    break;
                case 'customers':
                    renderCustomers();
                    break;
                case 'qr':
                    renderQrGenerator();
                    break;
            }
        }

        function renderError(title, message) {
            $("#page-content").innerHTML = `
                <div class="bg-red-900/50 border border-red-700 p-6 rounded-lg">
                    <h1 class="text-2xl font-bold text-red-300 mb-4">${title}</h1>
                    <pre class="text-sm text-red-200 whitespace-pre-wrap">${message}</pre>
                </div>`;
        }

        // --- DASHBOARD PAGE ---
        function renderDashboard() {
            const liveOrders = state.orders.filter(o => ['received', 'preparing'].includes(o.status));
            
            $("#page-content").innerHTML = `
                <h1 class="text-3xl font-bold brand-text mb-6">Dashboard</h1>
                
                <!-- Staff Calls -->
                <h2 class="text-2xl font-semibold text-yellow-300 mb-4">Live Staff Calls</h2>
                <div id="staff-calls-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
                    ${state.staffCalls.length === 0 ? '<p class="text-gray-400">No pending staff calls.</p>' : ''}
                    ${state.staffCalls.map(call => renderStaffCall(call)).join('')}
                </div>

                <!-- Live Orders -->
                <h2 class="text-2xl font-semibold brand-text mb-4">Live Orders (${liveOrders.length})</h2>
                <div id="live-orders-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    ${liveOrders.length === 0 ? '<p class="text-gray-400">No live orders.</p>' : ''}
                    ${liveOrders.map(order => renderOrderCard(order)).join('')}
                </div>
            `;

            // Add event listeners for new buttons
            $$('.resolve-call-btn').forEach(btn => btn.addEventListener('click', handleResolveCall));
        }

        function renderStaffCall(call) {
            const callType = call.call_type === 'payment' ? 'Payment Help' : 'General Assistance';
            const icon = call.call_type === 'payment' ? 'üíµ' : 'üõé';
            return `
                <div class="bg-red-800/70 p-4 rounded-lg shadow-lg border border-red-600 animate-pulse">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-xl font-bold text-white">Table ${call.table_number}</h3>
                        <span class="text-2xl">${icon}</span>
                    </div>
                    <p class="text-lg text-yellow-200 mb-3">${callType}</p>
                    <p class="text-xs text-gray-300 mb-4">Time: ${new Date(call.created_at).toLocaleTimeString()}</p>
                    <button class="resolve-call-btn w-full p-2 bg-yellow-500 text-black font-bold rounded" data-id="${call.id}">Resolve Call</button>
                </div>
            `;
        }

        async function handleResolveCall(e) {
            const callId = e.target.dataset.id;
            e.target.disabled = true;
            e.target.innerHTML = `<span class="flex items-center justify-center"><div class="spinner mr-2"></div> Resolving...</span>`;

            const { error } = await supabase
                .from('staff_calls')
                .update({ status: 'resolved' })
                .eq('id', callId);

            if (error) {
                console.error("Error resolving call:", error);
                e.target.disabled = false;
                e.target.textContent = 'Resolve Call';
            } else {
                // Remove from local state and re-render (this is optimistic)
                state.staffCalls = state.staffCalls.filter(call => call.id != callId);
                renderDashboard();
            }
        }

        function renderOrderCard(order) {
            const statusColor = order.status === 'received' ? 'bg-blue-600' : 'bg-yellow-600';
            const items = order.order_items.map(item => `
                <li class="flex justify-between">
                    <span class="text-gray-300">${item.products ? item.products.name : (item.product_name || 'Item')}</span>
                    <span class="font-medium text-gray-200">x ${item.quantity}</span>
                </li>
            `).join('');

            return `
                <div class="bg-[#1e1e3f] p-4 rounded-lg shadow-lg border border-gray-700">
                    <div class="flex justify-between items-center mb-3">
                        <div>
                            <h3 class="text-xl font-bold brand-text">Table ${order.tables.table_number}</h3>
                            <p class="text-sm text-gray-400">${order.customers.name}</p>
                        </div>
                        <span class="px-3 py-1 text-sm font-semibold ${statusColor} text-white rounded-full">${order.status}</span>
                    </div>
                    <ul class="space-y-1 mb-4">${items}</ul>
                    ${order.special_instructions ? `<p class="text-sm text-yellow-300 bg-yellow-900/50 p-2 rounded mb-4">"${order.special_instructions}"</p>` : ''}
                    <div class="flex space-x-2">
                        ${order.status === 'received' ? `<button onclick="updateOrderStatus(${order.id}, 'preparing')" class="w-full p-2 bg-yellow-600 text-white font-semibold rounded">Mark as Preparing</button>` : ''}
                        ${order.status === 'preparing' ? `<button onclick="updateOrderStatus(${order.id}, 'delivered')" class="w-full p-2 bg-green-600 text-white font-semibold rounded">Mark as Delivered</button>` : ''}
                        <button onclick="updateOrderStatus(${order.id}, 'cancelled')" class="w-1/3 p-2 bg-red-700 text-white font-semibold rounded">Cancel</button>
                    </div>
                </div>
            `;
        }

        // --- MENU PAGE ---
        function renderMenu() {
            $("#page-content").innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold brand-text">Menu Items (${state.products.length})</h1>
                    <button id="add-item-btn" class="p-3 brand-bg text-gray-900 font-bold rounded hover-brand-bg transition-colors">Add New Item</button>
                </div>
                <div class="bg-[#1e1e3f] rounded-lg shadow-lg border border-gray-700">
                    <table class="w-full">
                        <thead class="border-b border-gray-700">
                            <tr>
                                <th class="p-4 text-left">Name</th>
                                <th class="p-4 text-left">Price</th>
                                <th class="p-4 text-left">Category</th>
                                <th class="p-4 text-left">Brand</th>
                                <th class="p-4 text-left">Available</th>
                                <th class="p-4 text-left">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${state.products.map(item => `
                                <tr class="border-b border-gray-800 hover:bg-[#2a2a4e]">
                                    <td class="p-4 font-semibold">${item.name}</td>
                                    <td class="p-4">‚Çπ${item.price}</td>
                                    <td class="p-4 text-gray-400">${item.category}</td>
                                    <td class="p-4 text-gray-400">${item.brand}</td>
                                    <td class="p-4">
                                        <label class="inline-flex items-center cursor-pointer">
                                            <input type="checkbox" class="sr-only peer" ${item.is_available ? 'checked' : ''} onchange="toggleItemAvailability(${item.id}, this.checked)">
                                            <div class="relative w-11 h-6 bg-gray-600 rounded-full peer peer-focus:ring-4 peer-focus:ring-yellow-800 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-yellow-600"></div>
                                        </label>
                                    </td>
                                    <td class="p-4">
                                        <button class="edit-item-btn" data-id="${item.id}">‚úèÔ∏è</button>
                                        <button class="delete-item-btn" data-id="${item.id}">‚ùå</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            // Add event listeners
            $("#add-item-btn").addEventListener("click", () => showItemModal(null));
            $$(".edit-item-btn").forEach(btn => btn.addEventListener("click", (e) => {
                const item = state.products.find(p => p.id == e.currentTarget.dataset.id);
                showItemModal(item);
            }));
            $$(".delete-item-btn").forEach(btn => btn.addEventListener("click", (e) => {
                if (confirm("Are you sure you want to delete this item?")) {
                    deleteItem(e.currentTarget.dataset.id);
                }
            }));
        }

        // --- TABLES PAGE ---
        function renderTables() {
            $("#page-content").innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold brand-text">Tables (${state.tables.length})</h1>
                    <button id="add-table-btn" class="p-3 brand-bg text-gray-900 font-bold rounded hover-brand-bg transition-colors">Add New Table</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    ${state.tables.map(table => `
                        <div class="bg-[#1e1e3f] p-4 rounded-lg shadow-lg border border-gray-700">
                            <h3 class="text-xl font-bold brand-text mb-2">Table ${table.table_number}</h3>
                            <p class="text-gray-400 mb-4">${table.description || 'No description'}</p>
                            <button class="edit-table-btn w-full p-2 bg-gray-700 rounded" data-id="${table.id}">Edit</button>
                        </div>
                    `).join('')}
                </div>
            `;

            // Add event listeners
            $("#add-table-btn").addEventListener("click", () => showTableModal(null));
            $$(".edit-table-btn").forEach(btn => btn.addEventListener("click", (e) => {
                const table = state.tables.find(t => t.id == e.currentTarget.dataset.id);
                showTableModal(table);
            }));
        }

        // --- CUSTOMERS PAGE ---
        function renderCustomers() {
            $("#page-content").innerHTML = `
                <h1 class="text-3xl font-bold brand-text mb-6">Customers (${state.customers.length})</h1>
                <div class="bg-[#1e1e3f] rounded-lg shadow-lg border border-gray-700">
                    <table class="w-full">
                        <thead class="border-b border-gray-700">
                            <tr>
                                <th class="p-4 text-left">Name</th>
                                <th class="p-4 text-left">Phone</th>
                                <th class="p-4 text-left">Loyalty Points</th>
                                <th class="p-4 text-left">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${state.customers.map(cust => `
                                <tr class="border-b border-gray-800 hover:bg-[#2a2a4e]">
                                    <td class="p-4 font-semibold">${cust.name}</td>
                                    <td class="p-4 text-gray-400">${cust.whatsapp_number || 'N/A'}</td>
                                    <td class="p-4">${cust.loyalty_points || 0}</td>
                                    <td class="p-4 space-x-2">
                                        <button class="edit-cust-btn p-2 bg-gray-700 rounded" data-id="${cust.id}">Edit</button>
                                        <button class="adjust-points-btn p-2 bg-yellow-700 rounded" data-id="${cust.id}">Adjust Points</button>
                                        <button class="view-history-btn p-2 bg-blue-700 rounded" data-id="${cust.id}">View History</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            // Add event listeners
            $$(".edit-cust-btn").forEach(btn => btn.addEventListener("click", (e) => {
                const cust = state.customers.find(c => c.id == e.currentTarget.dataset.id);
                showCustomerModal(cust);
            }));
            $$(".view-history-btn").forEach(btn => btn.addEventListener("click", (e) => {
                showCustomerHistoryModal(e.currentTarget.dataset.id);
            }));
            $$(".adjust-points-btn").forEach(btn => btn.addEventListener("click", (e) => {
                const cust = state.customers.find(c => c.id == e.currentTarget.dataset.id);
                showLoyaltyModal(cust);
            }));
        }

        // --- QR GENERATOR PAGE ---
        function renderQrGenerator() {
             $("#page-content").innerHTML = `
                <h1 class="text-3xl font-bold brand-text mb-6">QR Code Generator</h1>
                <p class="text-gray-400 mb-6">QR codes for tables 1-10. Right-click to save.</p>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-6">
                    ${Array.from({ length: 10 }, (_, i) => i + 1).map(tableNum => `
                        <div class="bg-[#1e1e3f] p-4 rounded-lg shadow-lg border border-gray-700 text-center">
                            <h3 class="text-xl font-bold brand-text mb-3">Table ${tableNum}</h3>
                            <div id="qr-table-${tableNum}" class="flex justify-center items-center p-2 bg-white rounded"></div>
                        </div>
                    `).join('')}
                </div>
            `;

            // Generate QR codes
            setTimeout(() => {
                const customerAppUrl = 'https://bulb-77jm.onrender.com/?table=';
                for (let i = 1; i <= 10; i++) {
                    const qr = qrcode(0, 'L');
                    qr.addData(customerAppUrl + i);
                    qr.make();
                    $(`#qr-table-${i}`).innerHTML = qr.createImgTag(5, 5); // (cellSize, margin)
                }
            }, 0);
        }

        // --- MODALS ---
        function showModal(content) {
            $("#modal-container").innerHTML = `<div class="modal-content bg-[#1e1e3f] p-6 rounded-lg shadow-xl w-full max-w-md">${content}</div>`;
            $("#modal-container").classList.remove("hidden");
        }

        function closeModal() {
            $("#modal-container").classList.add("hidden");
            $("#modal-container").innerHTML = "";
        }

        function showItemModal(item) {
            const isNew = item === null;
            const title = isNew ? "Add New Item" : "Edit Item";
            showModal(`
                <h2 class="text-2xl font-bold brand-text mb-4">${title}</h2>
                <form id="item-form" class="space-y-4">
                    <input type="hidden" id="item-id" value="${item?.id || ''}">
                    <div>
                        <label class="block text-sm font-medium text-gray-400">Name</label>
                        <input type="text" id="item-name" class="w-full p-2 bg-[#2a2a4e] rounded border border-gray-700" value="${item?.name || ''}" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-400">Price (‚Çπ)</label>
                        <input type="number" id="item-price" class="w-full p-2 bg-[#2a2a4e] rounded border border-gray-700" value="${item?.price || 0}" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-400">Category</label>
                        <input type="text" id="item-category" class="w-full p-2 bg-[#2a2a4e] rounded border border-gray-700" value="${item?.category || ''}" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-400">Brand</label>
                        <select id="item-brand" class="w-full p-2 bg-[#2a2a4e] rounded border border-gray-700" required>
                            <option value="Bulb Cafe" ${item?.brand === 'Bulb Cafe' ? 'selected' : ''}>Bulb Cafe</option>
                            <option value="Gulabi Thali" ${item?.brand === 'Gulabi Thali' ? 'selected' : ''}>Gulabi Thali</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-400">Description</label>
                        <textarea id="item-desc" class="w-full p-2 bg-[#2a2a4e] rounded border border-gray-700" rows="3">${item?.description || ''}</textarea>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="item-available" class="h-4 w-4 rounded brand-bg border-gray-700" ${isNew || item?.is_available ? 'checked' : ''}>
                        <label for="item-available" class="ml-2 text-gray-300">Is Available</label>
                    </div>
                    <div class="flex justify-end space-x-2 pt-4">
                        <button type="button" id="cancel-btn" class="p-2 bg-gray-600 rounded">Cancel</button>
                        <button type="submit" class="p-2 brand-bg text-gray-900 font-bold rounded">${isNew ? "Create" : "Save Changes"}</button>
                    </div>
                </form>
            `);

            $("#cancel-btn").addEventListener("click", closeModal);
            $("#item-form").addEventListener("submit", saveItem);
        }

        function showTableModal(table) {
            const isNew = table === null;
            const title = isNew ? "Add New Table" : "Edit Table";
            showModal(`
                <h2 class="text-2xl font-bold brand-text mb-4">${title}</h2>
                <form id="table-form" class="space-y-4">
                    <input type="hidden" id="table-id" value="${table?.id || ''}">
                    <div>
                        <label class="block text-sm font-medium text-gray-400">Table Number</label>
                        <input type="number" id="table-number" class="w-full p-2 bg-[#2a2a4e] rounded border border-gray-700" value="${table?.table_number || ''}" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-400">Description</label>
                        <textarea id="table-desc" class="w-full p-2 bg-[#2a2a4e] rounded border border-gray-700" rows="3">${table?.description || ''}</textarea>
                    </div>
                    <div class="flex justify-end space-x-2 pt-4">
                        <button type="button" id="cancel-btn" class="p-2 bg-gray-600 rounded">Cancel</button>
                        <button type="submit" class="p-2 brand-bg text-gray-900 font-bold rounded">${isNew ? "Create" : "Save Changes"}</button>
                    </div>
                </form>
            `);
            
            $("#cancel-btn").addEventListener("click", closeModal);
            $("#table-form").addEventListener("submit", saveTable);
        }

        function showCustomerModal(cust) {
            showModal(`
                <h2 class="text-2xl font-bold brand-text mb-4">Edit Customer</h2>
                <form id="cust-form" class="space-y-4">
                    <input type="hidden" id="cust-id" value="${cust.id}">
                    <div>
                        <label class="block text-sm font-medium text-gray-400">Name</label>
                        <input type="text" id="cust-name" class="w-full p-2 bg-[#2a2a4e] rounded border border-gray-700" value="${cust.name}" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-400">Phone</label>
                        <input type="text" id="cust-phone" class="w-full p-2 bg-[#2a2a4e] rounded border border-gray-700" value="${cust.whatsapp_number || ''}" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-400">Loyalty Points</label>
                        <input type="number" id="cust-points" class="w-full p-2 bg-[#2a2a4e] rounded border border-gray-700" value="${cust.loyalty_points || 0}" required>
                    </div>
                    <div class="flex justify-end space-x-2 pt-4">
                        <button type="button" id="cancel-btn" class="p-2 bg-gray-600 rounded">Cancel</button>
                        <button type="submit" class="p-2 brand-bg text-gray-900 font-bold rounded">Save Changes</button>
                    </div>
                </form>
            `);
            
            $("#cancel-btn").addEventListener("click", closeModal);
            $("#cust-form").addEventListener("submit", saveCustomer);
        }

        function showLoyaltyModal(cust) {
            showModal(`
                <h2 class="text-2xl font-bold brand-text mb-4">Adjust Points</h2>
                <p class="text-lg mb-2">${cust.name}</p>
                <p class="text-gray-400 mb-4">Current Points: <span class="font-bold">${cust.loyalty_points || 0}</span></p>
                <form id="loyalty-form" class="space-y-4">
                    <input type="hidden" id="loyalty-cust-id" value="${cust.id}">
                    <input type="hidden" id="loyalty-current" value="${cust.loyalty_points || 0}">
                    <div>
                        <label class="block text-sm font-medium text-gray-400">Points to Add/Redeem</label>
                        <input type="number" id="loyalty-adjust" class="w-full p-2 bg-[#2a2a4e] rounded border border-gray-700" placeholder="e.g., 50 to add, -20 to redeem" required>
                    </div>
                    <div class="flex justify-end space-x-2 pt-4">
                        <button type="button" id="cancel-btn" class="p-2 bg-gray-600 rounded">Cancel</button>
                        <button type="submit" class="p-2 brand-bg text-gray-900 font-bold rounded">Adjust Points</button>
                    </div>
                </form>
            `);
            
            $("#cancel-btn").addEventListener("click", closeModal);
            $("#loyalty-form").addEventListener("submit", saveLoyaltyAdjustment);
        }

        async function showCustomerHistoryModal(customerId) {
            const { data, error } = await supabase
                .from('orders')
                .select(`*, order_items ( product_name, quantity )`)
                .eq('customer_id', customerId)
                .order('created_at', { ascending: false });

            if (error) {
                return showModal(`<p class="text-red-400">Error loading history: ${error.message}</p><button id="cancel-btn" class="p-2 bg-gray-600 rounded mt-4">Close</button>`);
            }
            
            const historyHTML = data.length > 0 ? data.map(o => {
                const items = o.order_items.map(i => `${i.product_name || 'Item'} (x${i.quantity})`).join(', ');
                return `
                    <div class="bg-[#2a2a4e] p-3 rounded-lg mb-3">
                        <div class="flex justify-between">
                            <span class="font-bold">Order #${o.id.slice(0,6)}</span>
                            <span class="brand-text">‚Çπ${o.final_amount.toFixed(2)}</span>
                        </div>
                        <p class="text-xs text-gray-400">${new Date(o.created_at).toLocaleString()}</p>
                        <p class="text-sm mt-2">${items}</p>
                    </div>
                `;
            }).join('') : '<p class="text-gray-400">No order history found.</p>';

            showModal(`
                <h2 class="text-2xl font-bold brand-text mb-4">Order History</h2>
                <div class="max-h-60 overflow-y-auto">${historyHTML}</div>
                <button type="button" id="cancel-btn" class="w-full mt-6 p-2 bg-gray-600 rounded">Close</button>
            `);
            $("#cancel-btn").addEventListener("click", closeModal);
        }


        // --- DATABASE ACTIONS ---
        async function updateOrderStatus(orderId, newStatus) {
            const { error } = await supabase
                .from('orders')
                .update({ status: newStatus })
                .eq('id', orderId);
            
            if (error) {
                console.error("Error updating status:", error);
            } else {
                console.log("Order status updated");
                // The realtime subscription will handle the UI update
            }
        }

        async function toggleItemAvailability(itemId, isAvailable) {
            const { error } = await supabase
                .from('products')
                .update({ is_available: isAvailable })
                .eq('id', itemId);
            
            if (error) {
                console.error("Error updating availability:", error);
                fetchAllData(); // Revert on error
            }
        }

        async function saveItem(e) {
            e.preventDefault();
            const formData = {
                name: $("#item-name").value,
                price: parseFloat($("#item-price").value),
                category: $("#item-category").value,
                brand: $("#item-brand").value,
                description: $("#item-desc").value,
                is_available: $("#item-available").checked,
            };
            const itemId = $("#item-id").value;
            
            let query;
            if (itemId) {
                // Update
                query = supabase.from('products').update(formData).eq('id', itemId);
            } else {
                // Insert
                query = supabase.from('products').insert(formData);
            }

            const { error } = await query;
            if (error) {
                alert("Error saving item: " + error.message);
            } else {
                closeModal();
                fetchAllData(); // Refresh data
            }
        }

        async function deleteItem(itemId) {
            const { error } = await supabase.from('products').delete().eq('id', itemId);
            if (error) {
                alert("Error deleting item: " + error.message);
            } else {
                fetchAllData(); // Refresh data
            }
        }
        
        async function saveTable(e) {
            e.preventDefault();
            const formData = {
                table_number: parseInt($("#table-number").value),
                description: $("#table-desc").value,
            };
            const tableId = $("#table-id").value;
            
            let query;
            if (tableId) {
                // Update
                query = supabase.from('tables').update(formData).eq('id', tableId);
            } else {
                // Insert
                query = supabase.from('tables').insert(formData);
            }

            const { error } = await query;
            if (error) {
                alert("Error saving table: " + error.message);
            } else {
                closeModal();
                fetchAllData(); // Refresh data
            }
        }
        
        async function saveCustomer(e) {
            e.preventDefault();
            const formData = {
                name: $("#cust-name").value,
                whatsapp_number: $("#cust-phone").value,
                loyalty_points: parseInt($("#cust-points").value),
            };
            const custId = $("#cust-id").value;
            
            const { error } = await supabase.from('customers').update(formData).eq('id', custId);

            if (error) {
                alert("Error saving customer: " + error.message);
            } else {
                closeModal();
                fetchAllData(); // Refresh data
            }
        }
        
        async function saveLoyaltyAdjustment(e) {
            e.preventDefault();
            const custId = $("#loyalty-cust-id").value;
            const currentPoints = parseInt($("#loyalty-current").value);
            const adjustment = parseInt($("#loyalty-adjust").value);
            
            if (isNaN(adjustment)) return alert("Invalid point value");
            if (currentPoints + adjustment < 0) {
                return alert("Cannot redeem more points than customer has.");
            }

            const newPoints = currentPoints + adjustment;

            const { error } = await supabase.from('customers').update({ loyalty_points: newPoints }).eq('id', custId);

            if (error) {
                alert("Error adjusting points: " + error.message);
            } else {
                closeModal();
                fetchAllData(); // Refresh data
            }
        }

        // --- GLOBAL FUNCTIONS for inline JS ---
        window.updateOrderStatus = updateOrderStatus;
        window.toggleItemAvailability = toggleItemAvailability;
        
        // --- STARTUP ---
        // FIX: Wait for the DOM content to be fully loaded.
        // This ensures that the Supabase CDN script in the <head>
        // has had time to load and populate window.supabase.
        document.addEventListener('DOMContentLoaded', () => {
            checkSession();
        });

    </script>
</body>
</html>


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bulb Cafe Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <style>
        :root {
            --bg-light: #f3f4f6;
            --bg-white: #ffffff;
            --text-dark: #1f2937;
            --text-gray: #6b7280;
            --border-light: #e5e7eb;
            --brand-yellow: #f59e0b;
            --brand-pink: #db2777;
            --brand-blue: #3b82f6;
            --accent-red: #ef4444;
            --accent-green: #22c55e;
        }
        body {
            background-color: var(--bg-light);
            color: var(--text-dark);
            font-family: 'Poppins', sans-serif;
        }
        .card {
            background-color: var(--bg-white);
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
            border: 1px solid var(--border-light);
        }
        /* Side Nav Link */
        .nav-link {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            color: var(--text-gray);
            transition: all 0.2s ease;
        }
        .nav-link.active {
            background-color: var(--brand-yellow);
            color: var(--bg-white);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .nav-link:not(.active):hover {
            background-color: var(--bg-light);
            color: var(--text-dark);
        }
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
        }
        .btn-primary {
            background-color: var(--brand-blue);
            color: var(--bg-white);
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .btn-secondary {
            background-color: var(--bg-light);
            color: var(--text-dark);
            border: 1px solid var(--border-light);
        }
        .btn-secondary:hover {
            background-color: #e5e7eb;
        }
        .btn-danger {
            background-color: var(--accent-red);
            color: var(--bg-white);
        }
        .btn-danger:hover {
            background-color: #dc2626;
        }
        .btn-success {
            background-color: var(--accent-green);
            color: var(--bg-white);
        }
        .btn-success:hover {
            background-color: #16a34a;
        }
        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .modal-content {
            background-color: var(--bg-white);
            padding: 1.5rem;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);
            max-height: 90vh; /* Allow modal to scroll */
            overflow-y: auto; /* Allow modal to scroll */
        }
        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-light);
            border-radius: 0.5rem;
            background-color: var(--bg-light);
        }
        .form-input:focus {
            outline: 2px solid var(--brand-blue);
            background-color: var(--bg-white);
        }
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-dark);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .order-card-new {
            animation: pulse-new 2s infinite;
        }
        @keyframes pulse-new {
            0%, 100% { box-shadow: 0 0 0 0 rgba(245, 159, 11, 0.7); }
            50% { box-shadow: 0 0 0 6px rgba(245, 159, 11, 0); }
        }
        .call-card-new {
            animation: pulse-call 2s infinite;
        }
        @keyframes pulse-call {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            50% { box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); }
        }
        
        /* Custom toggle switch */
        .toggle-label {
            position: relative;
            display: inline-flex;
            align-items: center;
            cursor: pointer;
        }
        .toggle-input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            width: 44px; /* w-11 */
            height: 24px; /* h-6 */
            background-color: #d1d5db; /* bg-gray-200 */
            border-radius: 9999px; /* rounded-full */
            transition: all 0.2s ease;
        }
        .toggle-slider:before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px; /* h-5 */
            height: 20px; /* w-5 */
            background-color: white;
            border-radius: 50%;
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        .toggle-input:checked + .toggle-slider {
            background-color: var(--accent-green); /* bg-green-600 */
        }
        .toggle-input:checked + .toggle-slider:before {
            transform: translateX(20px); /* peer-checked:after:translate-x-full */
        }

        .toggle-slider-pink {
            background-color: #d1d5db; /* Start gray */
        }
        .toggle-input:checked + .toggle-slider-pink {
             background-color: var(--brand-pink); /* Pink when checked */
        }
        
        /* Drag and Drop Styles */
        .draggable-row.dragging {
            opacity: 0.5;
            background: #f0f8ff; /* Light alice blue */
        }
        .drag-over-indicator td {
            padding: 0 !important;
        }
        .drag-over-indicator div {
            height: 2px;
            background-color: var(--brand-blue);
        }
        
        /* Customer Tab Styles */
        .customer-tab {
            padding: 0.5rem 1rem;
            font-weight: 600;
            color: var(--text-gray);
            border-bottom: 2px solid transparent;
            cursor: pointer;
        }
        .customer-tab.active {
            color: var(--brand-blue);
            border-bottom-color: var(--brand-blue);
        }
        .customer-tab:hover:not(.active) {
            color: var(--text-dark);
        }

    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body class="min-h-screen">

    <!-- Global Error Toast -->
    <div id="error-toast" class="hidden fixed top-4 right-4 z-[100] bg-red-600 text-white p-4 rounded-lg shadow-lg">
        <p id="error-message"></p>
    </div>

    <!-- Login Screen -->
    <div id="login-screen" class="flex items-center justify-center min-h-screen">
        <div class="card w-full max-w-sm p-8">
            <h1 class="text-3xl font-bold text-center mb-2" style="color: var(--brand-yellow);">BULB ADMIN</h1>
            <p class="text-center text-gray-600 mb-6">Please sign in to continue</p>
            <form id="login-form">
                <div class="mb-4">
                    <label for="email" class="form-label">Email</label>
                    <input type="email" id="email" class="form-input" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="form-label">Password</label>
                    <input type="password" id="password" class="form-input" required>
                </div>
                <button type="submit" id="login-button" class="btn btn-primary w-full py-3">
                    Sign In
                </button>
            </form>
        </div>
    </div>

    <!-- Main App Interface -->
    <div id="app" class="hidden flex h-screen">
        
        <!-- Sidebar -->
        <aside class="w-60 bg-white shadow-lg flex flex-col h-full flex-shrink-0 border-r border-gray-200">
            <div class="p-4 h-16 flex items-center border-b border-gray-200">
                <span class="text-2xl font-bold" style="color: var(--brand-yellow);">ðŸ’¡ BULB ADMIN</span>
            </div>
            <!-- UPDATED: Added 3 new tabs -->
            <nav id="nav-links" class="flex flex-col space-y-2 p-4">
                <button class="nav-link active" data-tab="dashboard">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18M3 6h18M3 18h18"></path></svg>
                    Dashboard
                </button>
                <button class="nav-link" data-tab="history">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Order History
                </button>
                <button class="nav-link" data-tab="reports">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                    Reports
                </button>
                <button class="nav-link" data-tab="categories">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path></svg>
                    Categories
                </button>
                <button class="nav-link" data-tab="menu">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
                    Menu Items
                </button>
                <button class="nav-link" data-tab="customers">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                    Customers
                </button>
                <button class="nav-link" data-tab="loyalty">
                     <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    Loyalty
                </button>
                <button class="nav-link" data-tab="tables">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h6m-6 4h6m-6 4h6"></path></svg>
                    Tables
                </button>
                <button class="nav-link" data-tab="qr">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    QR Generator
                </button>
                <button class="nav-link" data-tab="settings">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.096 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    Settings
                </button>
            </nav>
        </aside>

        <!-- Main Content Area -->
        <div class="flex-1 flex flex-col overflow-y-auto">
            <!-- Top bar for user -->
            <header class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-40">
                <div class="flex justify-end items-center h-16 px-4 sm:px-6 lg:px-8">
                    <span id="admin-email" class="text-gray-700 font-medium mr-4"></span>
                    <button id="logout-button" class="btn btn-secondary">Logout</button>
                </div>
            </header>

            <main class="p-4 sm:p-6 lg:p-8">
                <!-- Dashboard -->
                <div id="dashboard-tab" class="tab-content active">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Live Orders -->
                        <div class="lg:col-span-2 space-y-4">
                            <h2 class="text-2xl font-bold text-gray-800">Live Orders</h2>
                            <div id="live-orders-container" class="space-y-4">
                                <!-- Orders will be injected here -->
                                <div id="no-orders-msg" class="text-gray-500 card p-4">No active orders.</div>
                            </div>
                        </div>
                        <!-- Staff Calls -->
                        <div class="lg:col-span-1 space-y-4">
                            <h2 class="text-2xl font-bold text-gray-800">Live Staff Calls</h2>
                            <div id="staff-calls-container" class="space-y-4">
                                <!-- Staff calls will be injected here -->
                                <div id="no-calls-msg" class="text-gray-500 card p-4">No pending staff calls.</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Order History -->
                <div id="history-tab" class="tab-content space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800">Order History</h2>
                    <div class="card p-4 overflow-x-auto">
                        <table class="w-full min-w-max">
                            <thead class="border-b border-gray-200">
                                <tr>
                                    <th class="p-2 text-left font-semibold text-gray-600">Date & Time</th>
                                    <th class="p-2 text-left font-semibold text-gray-600">Customer</th>
                                    <th class="p-2 text-left font-semibold text-gray-600">Table</th>
                                    <th class="p-2 text-left font-semibold text-gray-600">Total</th>
                                    <th class="p-2 text-left font-semibold text-gray-600">Status</th>
                                    <th class="p-2 text-right font-semibold text-gray-600">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="history-table-body">
                                <!-- History will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- NEW: Reports Tab -->
                <div id="reports-tab" class="tab-content space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800">Reports</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="card p-6">
                            <h3 class="text-sm font-semibold text-gray-500 uppercase">Total Revenue (Delivered)</h3>
                            <p id="report-total-revenue" class="text-4xl font-bold text-gray-800 mt-2">â‚¹0.00</p>
                        </div>
                         <div class="card p-6">
                            <h3 class="text-sm font-semibold text-gray-500 uppercase">Total Orders (Delivered)</h3>
                            <p id="report-total-orders" class="text-4xl font-bold text-gray-800 mt-2">0</p>
                        </div>
                        <div class="card p-6">
                            <h3 class="text-sm font-semibold text-gray-500 uppercase">Total Customers (Non-Guest)</h3>
                            <p id="report-total-customers" class="text-4xl font-bold text-gray-800 mt-2">0</p>
                        </div>
                    </div>
                    <div class="card p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Top 10 Selling Items</h3>
                        <table class="w-full min-w-max">
                            <thead class="border-b border-gray-200">
                                <tr>
                                    <th class="p-2 text-left font-semibold text-gray-600">Item Name</th>
                                    <th class="p-2 text-right font-semibold text-gray-600">Quantity Sold</th>
                                </tr>
                            </thead>
                            <tbody id="report-top-items-body">
                                <tr><td colspan="2" class="p-4 text-center text-gray-500">No data.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- NEW: Categories Tab -->
                <div id="categories-tab" class="tab-content space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-800">Category Management</h2>
                        <button id="add-category-btn" class="btn btn-primary">Add New Category</button>
                    </div>
                    <div class="card p-4 overflow-x-auto">
                        <p class="text-sm text-gray-500 mb-4">Click and drag any row to change the category order.</p>
                        <table class="w-full min-w-max">
                            <thead class="border-b border-gray-200">
                                <tr>
                                    <th class="p-2 text-left font-semibold text-gray-600">Seq.</th>
                                    <th class="p-2 text-left font-semibold text-gray-600">Emoji</th>
                                    <th class="p-2 text-left font-semibold text-gray-600">Name</th>
                                    <th class="p-2 text-left font-semibold text-gray-600">Brand</th>
                                    <th class="p-2 text-right font-semibold text-gray-600">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="categories-table-body">
                                <!-- Categories will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>


                <!-- UPDATED: Menu Management (Items) -->
                <div id="menu-tab" class="tab-content space-y-6">
                    
                    <!-- This header will be dynamic -->
                    <div id="menu-header" class="flex justify-between items-center">
                        <h2 id="menu-title" class="text-2xl font-bold text-gray-800">Menu Items</h2>
                        <button id="add-item-btn" class="btn btn-primary hidden">Add New Item</button>
                    </div>

                    <!-- NEW: Category Selector View -->
                    <div id="menu-category-selector" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Category cards will be injected here -->
                    </div>

                    <!-- NEW: Item Table View (hidden by default) -->
                    <div id="menu-item-list-container" class="hidden">
                        <button id="back-to-categories-btn" class="btn btn-secondary mb-4">&larr; Back to Categories</button>
                        <div class="card p-4 overflow-x-auto">
                            <table class="w-full min-w-max">
                                <thead class="border-b border-gray-200">
                                    <tr>
                                        <!-- REMOVED: Seq. and Emoji -->
                                        <th class="p-2 text-left font-semibold text-gray-600">Name</th>
                                        <th class="p-2 text-left font-semibold text-gray-600">Price</th>
                                        <th class="p-2 text-left font-semibold text-gray-600">Available</th>
                                        <th class="p-2 text-left font-semibold text-gray-600">Orderable (Gulabi)</th>
                                        <th class="p-2 text-right font-semibold text-gray-600">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="menu-table-body">
                                    <!-- Menu items will be injected here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- UPDATED: Customer Management -->
                <div id="customers-tab" class="tab-content space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-800">Customer Management</h2>
                        <button id="download-csv-btn" class="btn btn-success">Download CSV</button>
                    </div>
                    
                    <!-- NEW: Customer filter tabs -->
                    <div class="card p-4">
                        <div id="customer-filter-tabs" class="flex border-b border-gray-200">
                            <button class="customer-tab active" data-filter="all">All Customers</button>
                            <button class="customer-tab" data-filter="today">Joined Today</button>
                            <button class="customer-tab" data-filter="7days">Joined Last 7 Days</button>
                            <button class="customer-tab" data-filter="30days">Joined Last 30 Days</button>
                        </div>
                    </div>
                    
                    <div class="card p-4 overflow-x-auto">
                        <table class="w-full min-w-max">
                            <thead class="border-b border-gray-200">
                                <tr>
                                    <th class="p-2 text-left font-semibold text-gray-600">Name</th>
                                    <th class="p-2 text-left font-semibold text-gray-600">Phone</th>
                                    <th class="p-2 text-left font-semibold text-gray-600">Loyalty Points</th>
                                    <th class="p-2 text-left font-semibold text-gray-600">Joined On</th>
                                    <th class="p-2 text-right font-semibold text-gray-600">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="customers-table-body">
                                <!-- Customers will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- NEW: Loyalty Tab -->
                <div id="loyalty-tab" class="tab-content space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800">Loyalty Leaders</h2>
                    <div class="card p-4 overflow-x-auto">
                        <table class="w-full min-w-max">
                            <thead class="border-b border-gray-200">
                                <tr>
                                    <th class="p-2 text-left font-semibold text-gray-600">Rank</th>
                                    <th class="p-2 text-left font-semibold text-gray-600">Name</th>
                                    <th class="p-2 text-left font-semibold text-gray-600">Phone</th>
                                    <th class="p-2 text-left font-semibold text-gray-600">Loyalty Points</th>
                                    <th class="p-2 text-right font-semibold text-gray-600">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="loyalty-table-body">
                                <!-- Loyalty leaders will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Table Management -->
                <div id="tables-tab" class="tab-content space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-800">Table Management</h2>
                        <button id="add-table-btn" class="btn btn-primary">Add New Table</button>
                    </div>
                    <div class="card p-4 overflow-x-auto">
                        <table class="w-full min-w-max">
                            <thead class="border-b border-gray-200">
                                <tr>
                                    <th class="p-2 text-left font-semibold text-gray-600">Table #</th>
                                    <th class="p-2 text-left font-semibold text-gray-600">Description</th>
                                    <th class="p-2 text-right font-semibold text-gray-600">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="tables-table-body">
                                <!-- Tables will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- QR Generator -->
                <div id="qr-tab" class="tab-content">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Table QR Codes (1-10)</h2>
                        <button onclick="window.print()" class="btn btn-primary">Print All</button>
                    </div>
                    <div id="qr-code-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6">
                        <!-- QR codes will be injected here -->
                    </div>
                </div>
                
                <!-- NEW: Settings Tab -->
                <div id="settings-tab" class="tab-content space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800">App Settings</h2>
                    
                    <!-- Gulabi Thali Toggle -->
                    <div class="card p-6">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="text-lg font-bold text-gray-800">Gulabi Thali Ordering Status</h3>
                                <p class="text-sm text-gray-500 mt-1">When **On**, customers viewing the Gulabi Thali menu can place orders. When **Off**, it is **View Only**.</p>
                            </div>
                            <label class="toggle-label">
                                <input type="checkbox" id="gulabi-ordering-toggle" class="toggle-input" onchange="actions.toggleGulabiOrdering(this.checked)">
                                <span class="toggle-slider toggle-slider-pink" id="gulabi-ordering-slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Loyalty Settings -->
                    <div class="card p-6">
                        <form id="settings-form">
                            <h3 class="text-lg font-bold text-gray-800">Loyalty Settings</h3>
                            <p class="text-sm text-gray-500 mt-1 mb-4">Control the thresholds for earning loyalty points.</p>
                            
                            <div class="max-w-sm">
                                <label for="loyalty-threshold-input" class="form-label">Loyalty Threshold (â‚¹)</label>
                                <input type="number" id="loyalty-threshold-input" class="form-input" placeholder="e.g., 350">
                                <p class="text-xs text-gray-500 mt-1">Min. order subtotal to earn 10% points.</p>
                            </div>
                            
                            <div class="mt-6">
                                <button type="submit" class="btn btn-primary">Save Settings</button>
                            </div>
                        </form>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal Container -->
    <div id="modal-container" class="hidden"></div>

    <script type="module">
        // --- SUPABASE CONFIG ---
        const SUPABASE_URL = 'https://vrvlvvlfzbdqwfsdlrkv.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZydmx2dmxmemJkcXdmc2Rscmt2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5NzI2NzAsImV4cCI6MjA3NzU0ODY3MH0.yYnxeipLuO0DlTvGITI5ajHDeoWZ80N2PS3rPhuOyp8';
        let supabase = null;

        // --- NOTIFICATION SOUND ---
        const NOTIFICATION_URL = 'https://vrvlvvlfzbdqwfsdlrkv.supabase.co/storage/v1/object/public/video/new-notification-022-370046.mp3';
        let audioContext;
        let audioBuffer;
        let hasInteracted = false;

        async function initAudio() {
            if (audioContext) return;
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const response = await fetch(NOTIFICATION_URL);
                const arrayBuffer = await response.arrayBuffer();
                audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                console.log("Audio initialized");
            } catch (e) {
                console.error("Error initializing audio:", e);
            }
        }

        function playNotification() {
            if (!audioContext || !audioBuffer) {
                console.warn("Audio not ready.");
                return;
            }
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            const source = audioContext.createBufferSource();
            source.buffer = audioBuffer;
            source.connect(audioContext.destination);
            source.start(0);
        }
        
        // --- APP STATE ---
        const state = {
            user: null,
            liveOrders: [],
            pastOrders: [],
            staffCalls: [],
            menu: [],
            categories: [], // NEW
            customers: [],
            tables: [],
            orderSubscription: null,
            callSubscription: null,
            appSettings: {},
            currentMenuCategory: null, // NEW: Tracks which category is being viewed
            customerFilter: 'all', // NEW: For customer time filters
        };

        // --- DOM SELECTORS ---
        const $ = (id) => document.getElementById(id);
        const $$ = (sel) => document.querySelectorAll(sel);

        // --- TOAST NOTIFICATION ---
        function renderToast(message, autoHide = true, type = 'error') {
            if (type === 'error') {
                console.error(message); // Log as error
            } else {
                console.log(message); // Log as info
            }
            
            const toast = $('error-toast');
            const msgEl = $('error-message');
            msgEl.textContent = message;
            toast.classList.remove('hidden');

            // Change color based on type
            if (type === 'info') {
                toast.classList.remove('bg-red-600');
                toast.classList.add('bg-blue-600');
            } else { // default to error
                toast.classList.remove('bg-blue-600');
                toast.classList.add('bg-red-600');
            }

            if (autoHide) {
                setTimeout(() => {
                    toast.classList.add('hidden');
                }, 3000); 
            }
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            try {
                const { createClient } = window.supabase;
                if (!createClient) {
                    throw new Error("Supabase client library not found on window.supabase.");
                }
                supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log("Supabase client initialized.");
                
                auth.checkSession();
            } catch (e) {
                console.error("CRITICAL: SUPABASE initialization failed.", e);
                renderToast(`CRITICAL: App failed to start. ${e.message}`, false, 'error');
            }
        });


        // --- AUTHENTICATION ---
        const auth = {
            async checkSession() {
                try {
                    const { data, error } = await supabase.auth.getSession();
                    if (error) throw error;
                    
                    if (data.session) {
                        state.user = data.session.user;
                        this.showApp();
                        document.body.addEventListener('click', () => {
                            if (!hasInteracted) {
                                initAudio();
                                hasInteracted = true;
                            }
                        }, { once: true });
                    } else {
                        this.showLogin();
                    }
                } catch (e) {
                    renderToast(`Auth Error: ${e.message}`);
                    this.showLogin();
                }
            },
            async login(email, password) {
                const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) {
                    renderToast(error.message);
                } else {
                    state.user = data.user;
                    this.showApp();
                    document.body.addEventListener('click', initAudio, { once: true });
                }
            },
            async logout() {
                await supabase.auth.signOut();
                state.user = null;
                this.showLogin();
            },
            showLogin() {
                $('login-screen').classList.remove('hidden');
                $('app').classList.add('hidden');
            },
            async showApp() {
                $('login-screen').classList.add('hidden');
                $('app').classList.remove('hidden');
                $('admin-email').textContent = state.user.email;
                
                await loadInitialData();
                
                listeners.startOrderListener();
                listeners.startCallListener();
                
                // NEW: Initialize drag-and-drop listeners
                dragDrop.init();
            }
        };

        // --- DATA LOADING ---
        async function loadInitialData() {
            try {
                // Fetch products and categories ordered by sequence_id
                const [ordersRes, callsRes, menuRes, categoriesRes, customersRes, tablesRes, settingsRes] = await Promise.all([ 
                    supabase.from('orders').select('*, tables(table_number), customers(name), order_items(*, products(name))').order('created_at', { ascending: false }),
                    supabase.from('staff_calls').select('*').eq('status', 'pending').order('created_at', { ascending: true }),
                    supabase.from('products').select('*').order('name', { ascending: true }), // Items sorted by name
                    supabase.from('categories').select('*').order('sequence_id', { ascending: true }).order('name', { ascending: true }), // Categories sorted by sequence
                    // UPDATED: Filter out 'Guest' customers
                    supabase.from('customers').select('*').neq('name', 'Guest').order('name', { ascending: true }),
                    supabase.from('tables').select('*').order('table_number', { ascending: true }),
                    supabase.from('app_settings').select('key, value') 
                ]);

                if (ordersRes.error) throw ordersRes.error;
                if (callsRes.error) throw callsRes.error;
                if (menuRes.error) throw menuRes.error;
                if (categoriesRes.error) throw categoriesRes.error;
                if (customersRes.error) throw customersRes.error;
                if (tablesRes.error) throw tablesRes.error;
                if (settingsRes.error) throw settingsRes.error; 

                state.liveOrders = ordersRes.data.filter(o => o.status === 'received' || o.status === 'preparing');
                state.pastOrders = ordersRes.data.filter(o => o.status === 'delivered' || o.status === 'cancelled');
                
                state.staffCalls = callsRes.data;
                state.menu = menuRes.data;
                state.categories = categoriesRes.data; // NEW
                state.customers = customersRes.data;
                state.tables = tablesRes.data;
                
                state.appSettings = settingsRes.data.reduce((acc, { key, value }) => ({ ...acc, [key]: value }), {});

                render.all();

            } catch (error) {
                renderToast(`Error Loading Data: ${error.message}\nThis is likely an RLS (Row Level Security) issue.\nYour RLS policies are probably blocking this admin account from viewing all data. You must update your policies in the Supabase dashboard to grant full access to this logged-in user.`);
                console.error("Detailed Load Error:", error);
            }
        }

        // --- REAL-TIME LISTENERS ---
        const listeners = {
            startOrderListener() {
                if (state.orderSubscription) return;
                state.orderSubscription = supabase.channel('public:orders')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'orders' }, (payload) => {
                        console.log('Order change received:', payload);
                        
                        if (payload.eventType === 'INSERT' && (payload.new.status === 'received' || payload.new.status === 'preparing')) {
                            fetchOrderDetails(payload.new.id);
                            playNotification();
                        }
                        else if (payload.eventType === 'UPDATE') {
                            const updatedOrder = payload.new;
                            const index = state.liveOrders.findIndex(o => o.id === updatedOrder.id);
                            
                            if (index > -1) {
                                if (updatedOrder.status !== 'received' && updatedOrder.status !== 'preparing') {
                                    const finishedOrder = state.liveOrders.splice(index, 1)[0];
                                    finishedOrder.status = updatedOrder.status;
                                    state.pastOrders.unshift(finishedOrder);
                                    render.history();
                                    render.reports(); // Update reports on delivered order
                                } else {
                                    fetchOrderDetails(updatedOrder.id, index);
                                }
                            }
                            else if (updatedOrder.status === 'received' || updatedOrder.status === 'preparing') {
                                fetchOrderDetails(updatedOrder.id);
                                const pastIndex = state.pastOrders.findIndex(o => o.id === updatedOrder.id);
                                if (pastIndex > -1) {
                                    state.pastOrders.splice(pastIndex, 1);
                                    render.history();
                                }
                            }
                        }
                        render.dashboard();
                    })
                    .subscribe();
            },

            startCallListener() {
                if (state.callSubscription) return;
                state.callSubscription = supabase.channel('public:staff_calls')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'staff_calls' }, (payload) => {
                        console.log('Staff call change received:', payload);
                        
                        if (payload.eventType === 'INSERT' && payload.new.status === 'pending') {
                            state.staffCalls.push(payload.new);
                            playNotification();
                        }
                        else if (payload.eventType === 'UPDATE') {
                            const index = state.staffCalls.findIndex(c => c.id === payload.new.id);
                            if (payload.new.status !== 'pending' && index > -1) {
                                state.staffCalls.splice(index, 1);
                            } else if (payload.new.status === 'pending' && index === -1) {
                                state.staffCalls.push(payload.new);
                            }
                        }
                        render.dashboard();
                    })
                    .subscribe();
            },
        };

        // Helper to fetch full order details
        async function fetchOrderDetails(orderId, updateIndex = -1) {
            try {
                const { data, error } = await supabase.from('orders')
                    .select('*, tables(table_number), customers(name), order_items(*, products(name))')
                    .eq('id', orderId)
                    .single();
                
                if (error) throw error;
                
                // Ensure order_items is an array
                if (!data.order_items) {
                    data.order_items = [];
                }

                if (updateIndex > -1) {
                    state.liveOrders[updateIndex] = data; // Replace existing
                } else {
                    if (!state.liveOrders.some(o => o.id === data.id)) {
                        state.liveOrders.push(data);
                    }
                }
                render.dashboard();
            } catch (e) {
                console.error("Failed to fetch order details:", e);
                if (e && e.message && e.message.includes("Cannot read properties of null (reading 'classList')")) {
                    renderToast("Dashboard render error: " + e.message);
                }
            }
        }


        // --- RENDERING ---
        const render = {
            all() {
                this.dashboard();
                this.history();
                this.reports(); // NEW
                this.categories(); // NEW
                this.menu(); // This will now render categories first
                this.customers();
                this.loyalty(); // NEW
                this.tables();
                this.qr();
                this.settings(); // NEW
            },

            dashboard() {
                const ordersContainer = $('live-orders-container');
                const noOrdersMsg = $('no-orders-msg');
                
                if (state.liveOrders.length === 0) {
                    ordersContainer.innerHTML = '';
                    if(noOrdersMsg) noOrdersMsg.classList.remove('hidden');
                } else {
                    if(noOrdersMsg) noOrdersMsg.classList.add('hidden');
                    state.liveOrders.sort((a, b) => {
                        if (a.status === 'received' && b.status !== 'received') return -1;
                        if (a.status !== 'received' && b.status === 'received') return 1;
                        return new Date(b.created_at) - new Date(a.created_at);
                    });
                    
                    ordersContainer.innerHTML = state.liveOrders.map(order => {
                        const isNew = order.status === 'received';
                        const items = order.order_items || [];
                        const time = new Date(order.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        
                        return `
                            <div class="card p-4 ${isNew ? 'order-card-new' : ''} border-2 ${isNew ? 'border-yellow-500' : 'border-transparent'}">
                                <div class="flex justify-between items-center mb-3">
                                    <div>
                                        <h3 class="text-xl font-bold">Table #${order.tables?.table_number || 'N/A'}</h3>
                                        <p class="text-gray-600">by ${order.customers?.name || 'Guest'} at ${time}</p>
                                    </div>
                                    <span class="text-lg font-bold ${isNew ? 'text-yellow-600' : 'text-blue-600'} capitalize">${order.status}</span>
                                </div>
                                <div class="border-t border-gray-100 pt-3 mb-4">
                                    <ul class="space-y-1">
                                        ${items.map(item => `
                                            <li class="flex justify-between">
                                                <span class="text-gray-800">${item.product_name || (item.products ? item.products.name : 'Item')}</span>
                                                <span class="font-medium text-gray-600">x${item.quantity}</span>
                                            </li>
                                        `).join('')}
                                    </ul>
                                    ${order.special_instructions ? `
                                        <p class="mt-3 text-sm italic text-yellow-800 bg-yellow-100 p-2 rounded-md">
                                            <strong>Note:</strong> ${order.special_instructions}
                                        </p>
                                    ` : ''}
                                </div>
                                <div class="flex gap-2">
                                    ${isNew ? `
                                        <button class="btn btn-primary flex-1" onclick="actions.updateOrderStatus('${order.id}', 'preparing')">
                                            Mark as Preparing
                                        </button>
                                    ` : `
                                        <button class="btn btn-success flex-1" onclick="actions.updateOrderStatus('${order.id}', 'delivered')">
                                            Mark as Delivered
                                        </button>
                                    `}
                                    <button class="btn btn-secondary" onclick="actions.updateOrderStatus('${order.id}', 'cancelled')">
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
                }

                // Render Staff Calls
                const callsContainer = $('staff-calls-container');
                const noCallsMsg = $('no-calls-msg');
                
                if (state.staffCalls.length === 0) {
                    callsContainer.innerHTML = '';
                    if(noCallsMsg) noCallsMsg.classList.remove('hidden');
                } else {
                    if(noCallsMsg) noCallsMsg.classList.add('hidden');
                    state.staffCalls.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                    
                    callsContainer.innerHTML = state.staffCalls.map(call => {
                        const time = new Date(call.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        return `
                            <div class="card p-4 call-card-new border-2 border-red-500">
                                <div class="flex justify-between items-center mb-2">
                                    <h3 class="text-xl font-bold">Table #${call.table_number}</h3>
                                    <span class="text-sm text-gray-500">${time}</span>
                                </div>
                                <p class="text-lg text-red-700 font-semibold capitalize mb-3">${call.call_type === 'payment' ? 'Needs Payment' : 'Needs Assistance'}</p>
                                <button class="btn btn-danger w-full" onclick="actions.resolveStaffCall('${call.id}')">
                                    Resolve
                                </button>
                            </div>
                        `;
                    }).join('');
                }
            },

            history() {
                const historyBody = $('history-table-body');
                if (state.pastOrders.length === 0) {
                    historyBody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500">No past orders found.</td></tr>';
                    return;
                }
                historyBody.innerHTML = state.pastOrders.map(order => {
                    const time = new Date(order.created_at).toLocaleString();
                    const statusColor = order.status === 'delivered' ? 'text-green-600' : 'text-red-600';
                    return `
                        <tr class="border-b border-gray-100">
                            <td class="p-2">${time}</td>
                            <td class="p-2">${order.customers?.name || 'Guest'}</td>
                            <td class="p-2">${order.tables?.table_number || 'N/A'}</td>
                            <td class="p-2">â‚¹${(order.final_amount || 0).toFixed(2)}</td>
                            <td class="p-2 font-semibold ${statusColor} capitalize">${order.status}</td>
                            <td class="p-2 text-right">
                                <button class="btn btn-danger btn-sm" onclick="actions.deleteOrder('${order.id}', '${order.customers?.name || 'Guest'}')">
                                    Delete
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            },
            
            // NEW: Render Reports
            reports() {
                const deliveredOrders = state.pastOrders.filter(o => o.status === 'delivered');
                
                // 1. Total Revenue
                const totalRevenue = deliveredOrders.reduce((acc, order) => acc + (order.final_amount || 0), 0);
                $('report-total-revenue').textContent = `â‚¹${totalRevenue.toFixed(2)}`;
                
                // 2. Total Orders
                $('report-total-orders').textContent = deliveredOrders.length;
                
                // 3. Total Customers
                $('report-total-customers').textContent = state.customers.length;
                
                // 4. Top Items
                const itemCounts = {};
                for (const order of deliveredOrders) {
                    for (const item of (order.order_items || [])) {
                        const name = item.product_name || (item.products ? item.products.name : 'Unknown Item');
                        itemCounts[name] = (itemCounts[name] || 0) + item.quantity;
                    }
                }
                
                const sortedItems = Object.entries(itemCounts).sort(([,a],[,b]) => b - a);
                const topItemsBody = $('report-top-items-body');
                
                if (sortedItems.length === 0) {
                     topItemsBody.innerHTML = '<tr><td colspan="2" class="p-4 text-center text-gray-500">No item data.</td></tr>';
                } else {
                    topItemsBody.innerHTML = sortedItems.slice(0, 10).map(([name, count]) => `
                        <tr class="border-b border-gray-100">
                            <td class="p-2">${name}</td>
                            <td class="p-2 text-right font-bold">${count}</td>
                        </tr>
                    `).join('');
                }
            },

            // NEW: Render Categories
            categories() {
                const categoriesBody = $('categories-table-body');
                
                // Sort by sequence_id, then by name
                const sortedCategories = state.categories.sort((a, b) => {
                    const seqA = a.sequence_id ?? 99;
                    const seqB = b.sequence_id ?? 99;
                    if (seqA < seqB) return -1;
                    if (seqA > seqB) return 1;
                    return a.name.localeCompare(b.name);
                });
                
                categoriesBody.innerHTML = sortedCategories.map(cat => `
                    <tr class="border-b border-gray-100 draggable-row bg-white cursor-move" draggable="true" data-item-id="${cat.id}">
                        <td class="p-2 font-bold text-gray-500">${cat.sequence_id ?? 99}</td>
                        <td class="p-2 text-lg">${cat.emoji || ''}</td>
                        <td class="p-2">${cat.name}</td>
                        <td class="p-2">${cat.brand}</td>
                        <td class="p-2 text-right">
                            <button class="btn btn-secondary btn-sm" onclick="actions.showCategoryModal('${cat.id}')">Edit</button>
                        </td>
                    </tr>
                `).join('');
            },

            // UPDATED: Render Menu
            menu() {
                const categorySelector = $('menu-category-selector');
                const itemListContainer = $('menu-item-list-container');
                const menuTitle = $('menu-title');
                const addItemBtn = $('add-item-btn');

                if (state.currentMenuCategory === null) {
                    // --- Show Category Selector ---
                    menuTitle.textContent = 'Menu Items';
                    addItemBtn.classList.add('hidden');
                    categorySelector.classList.remove('hidden');
                    itemListContainer.classList.add('hidden');
                    
                    const sortedCategories = state.categories.sort((a, b) => {
                        const seqA = a.sequence_id ?? 99;
                        const seqB = b.sequence_id ?? 99;
                        if (seqA < seqB) return -1;
                        if (seqA > seqB) return 1;
                        return a.name.localeCompare(b.name);
                    });

                    categorySelector.innerHTML = sortedCategories.map(cat => {
                        const itemCount = state.menu.filter(item => item.category === cat.name && item.brand === cat.brand).length;
                        const brandColor = cat.brand === 'Bulb Cafe' ? 'border-l-brand-yellow' : 'border-l-brand-pink';
                        return `
                            <div class="card p-4 flex justify-between items-center cursor-pointer hover:shadow-md transition-shadow ${brandColor} border-l-4"
                                 onclick="actions.viewItemsForCategory('${cat.name}', '${cat.brand}')">
                                <div>
                                    <h3 class="text-lg font-bold text-gray-800 flex items-center">
                                        <span class="text-xl mr-2">${cat.emoji || 'ðŸ½ï¸'}</span>
                                        ${cat.name}
                                    </h3>
                                    <p class="text-sm text-gray-500">${itemCount} items</p>
                                </div>
                                <span class="text-2xl text-gray-400">&rarr;</span>
                            </div>
                        `;
                    }).join('');

                } else {
                    // --- Show Item List ---
                    const { name, brand } = state.currentMenuCategory;
                    menuTitle.textContent = `${name} (Items)`;
                    addItemBtn.classList.remove('hidden');
                    categorySelector.classList.add('hidden');
                    itemListContainer.classList.remove('hidden');

                    const menuBody = $('menu-table-body');
                    const itemsForCategory = state.menu.filter(item => item.category === name && item.brand === brand);
                    
                    menuBody.innerHTML = itemsForCategory.map(item => `
                        <tr class="border-b border-gray-100 bg-white">
                            <td class="p-2">${item.name}</td>
                            <td class="p-2">â‚¹${item.price}</td>
                            <td class="p-2">
                                <label class="toggle-label">
                                    <input type="checkbox" ${item.is_available ? 'checked' : ''} class="toggle-input" onchange="actions.toggleItemAvailability('${item.id}', this.checked)">
                                    <span class="toggle-slider"></span>
                                </label>
                            </td>
                            <td class="p-2">
                                ${item.brand === 'Gulabi Thali' ? `
                                    <label class="toggle-label">
                                        <input type="checkbox" ${item.is_dine_in_orderable ? 'checked' : ''} class="toggle-input" onchange="actions.toggleItemOrderable('${item.id}', this.checked)">
                                        <span class="toggle-slider"></span>
                                    </label>
                                ` : '<span class="text-gray-400">N/A</span>'}
                            </td>
                            <td class="p-2 text-right">
                                <button class="btn btn-secondary btn-sm" onclick="actions.showMenuModal('${item.id}')">Edit</button>
                            </td>
                        </tr>
                    `).join('');
                }
            },

            // UPDATED: Render Customers
            customers() {
                const customersBody = $('customers-table-body');
                
                // Apply time filter
                const now = new Date();
                const todayStart = new Date(now.setHours(0, 0, 0, 0));
                const sevenDaysAgo = new Date(new Date().setDate(now.getDate() - 7));
                const thirtyDaysAgo = new Date(new Date().setDate(now.getDate() - 30));
                
                const filteredCustomers = state.customers.filter(cust => {
                    const joinedDate = new Date(cust.created_at);
                    switch (state.customerFilter) {
                        case 'today':
                            return joinedDate >= todayStart;
                        case '7days':
                            return joinedDate >= sevenDaysAgo;
                        case '30days':
                            return joinedDate >= thirtyDaysAgo;
                        case 'all':
                        default:
                            return true;
                    }
                });
                
                if (filteredCustomers.length === 0) {
                    customersBody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500">No customers found for this filter.</td></tr>';
                    return;
                }
                
                customersBody.innerHTML = filteredCustomers.map(cust => `
                    <tr class="border-b border-gray-100">
                        <td class="p-2">${cust.name}</td>
                        <td class="p-2">${cust.whatsapp_number || 'N/A'}</td>
                        <td class="p-2">${cust.loyalty_points || 0}</td>
                        <td class="p-2">${new Date(cust.created_at).toLocaleDateString()}</td>
                        <td class="p-2 text-right space-x-2">
                            <button class="btn btn-secondary btn-sm" onclick="actions.showLoyaltyModal('${cust.id}', '${cust.name}', ${cust.loyalty_points || 0})">Adjust Points</button>
                            <button class="btn btn-secondary btn-sm" onclick="actions.showCustomerModal('${cust.id}')">Edit</button>
                            <button class="btn btn-danger btn-sm" onclick="actions.deleteCustomer('${cust.id}', '${cust.name}')">Delete</button>
                        </td>
                    </tr>
                `).join('');
            },
            
            // NEW: Render Loyalty
            loyalty() {
                const loyaltyBody = $('loyalty-table-body');
                const sortedCustomers = [...state.customers]
                    .filter(c => c.loyalty_points > 0)
                    .sort((a, b) => (b.loyalty_points || 0) - (a.loyalty_points || 0));
                
                if (sortedCustomers.length === 0) {
                    loyaltyBody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500">No customers with loyalty points.</td></tr>';
                    return;
                }

                loyaltyBody.innerHTML = sortedCustomers.map((cust, index) => `
                    <tr class="border-b border-gray-100">
                        <td class="p-2 font-bold">#${index + 1}</td>
                        <td class="p-2">${cust.name}</td>
                        <td class="p-2">${cust.whatsapp_number || 'N/A'}</td>
                        <td class="p-2 font-bold text-blue-600">${cust.loyalty_points || 0}</td>
                        <td class="p-2 text-right">
                            <button class="btn btn-secondary btn-sm" onclick="actions.showLoyaltyModal('${cust.id}', '${cust.name}', ${cust.loyalty_points || 0})">Adjust Points</button>
                        </td>
                    </tr>
                `).join('');
            },

            tables() {
                const tablesBody = $('tables-table-body');
                tablesBody.innerHTML = state.tables.map(table => `
                    <tr class="border-b border-gray-100">
                        <td class="p-2 font-bold">${table.table_number}</td>
                        <td class="p-2">${table.description || 'N/A'}</td>
                        <td class="p-2 text-right">
                            <button class="btn btn-secondary btn-sm" onclick="actions.showTableModal('${table.id}')">Edit</button>
                        </td>
                    </tr>
                `).join('');
            },

            qr() {
                const container = $('qr-code-container');
                // IMPORTANT: Make sure this URL is correct for your deployed client-side app
                const customerAppUrl = 'https://index-4-html-vpmc.onrender.com/';
                container.innerHTML = ''; // Clear
                for (let i = 1; i <= 10; i++) {
                    const url = `${customerAppUrl}?table=${i}`;
                    const wrapper = document.createElement('div');
                    wrapper.className = 'card p-4 flex flex-col items-center';
                    
                    const canvas = document.createElement('canvas');
                    canvas.id = `qr-canvas-${i}`;
                    
                    const label = document.createElement('h3');
                    label.className = 'text-lg font-bold mt-3';
                    label.textContent = `Table ${i}`;
                    
                    wrapper.appendChild(canvas);
                    wrapper.appendChild(label);
                    container.appendChild(wrapper);
                    
                    new QRious({
                        element: canvas,
                        value: url,
                        size: 200,
                        padding: 10,
                        level: 'H'
                    });
                }
            },
            
            // NEW: Render Settings
            settings() {
                // Gulabi Toggle
                const toggle = $('gulabi-ordering-toggle');
                const isEnabled = state.appSettings.gulabi_ordering_enabled === 'true';
                if (toggle) toggle.checked = isEnabled;
                
                const slider = $('gulabi-ordering-slider');
                if (slider) slider.classList.toggle('checked', isEnabled);
                
                // Loyalty Threshold
                const thresholdInput = $('loyalty-threshold-input');
                if (thresholdInput) {
                    thresholdInput.value = state.appSettings.loyalty_threshold || '350';
                }
            }
        };

        // --- DRAG & DROP LOGIC (Now for Categories) ---
        const dragDrop = {
            draggedItem: null,
            tableName: 'categories', // Target table for drag/drop
            
            init() {
                const categoriesTableBody = $('categories-table-body');
                
                categoriesTableBody.addEventListener('dragstart', this.handleDragStart.bind(this));
                categoriesTableBody.addEventListener('dragover', this.handleDragOver.bind(this));
                categoriesTableBody.addEventListener('dragleave', this.handleDragLeave.bind(this));
                categoriesTableBody.addEventListener('dragend', this.handleDragEnd.bind(this));
                categoriesTableBody.addEventListener('drop', this.handleDrop.bind(this));
            },
            handleDragStart(e) {
                this.draggedItem = e.target.closest('tr.draggable-row');
                if (!this.draggedItem) return;
                
                setTimeout(() => {
                    if (this.draggedItem) this.draggedItem.classList.add('dragging');
                }, 0);
                
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', this.draggedItem.dataset.itemId);
            },
            handleDragOver(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                const targetRow = e.target.closest('tr.draggable-row');
                
                $$('.drag-over-indicator').forEach(el => el.remove());

                if (targetRow && targetRow !== this.draggedItem) {
                    const indicator = document.createElement('tr');
                    indicator.classList.add('drag-over-indicator');
                    // Colspan 5 for categories table
                    indicator.innerHTML = `<td colspan="5"><div></div></td>`; 
                    
                    const rect = targetRow.getBoundingClientRect();
                    const offsetY = e.clientY - rect.top;
                    
                    if (offsetY < rect.height / 2) {
                        targetRow.before(indicator);
                    } else {
                        targetRow.after(indicator);
                    }
                }
            },
            handleDragLeave(e) {
                if (e.currentTarget.contains(e.relatedTarget)) return;
                $$('.drag-over-indicator').forEach(el => el.remove());
            },
            handleDragEnd() {
                if (this.draggedItem) {
                    this.draggedItem.classList.remove('dragging');
                }
                $$('.drag-over-indicator').forEach(el => el.remove());
                this.draggedItem = null;
            },
            async handleDrop(e) {
                e.preventDefault();
                if (!this.draggedItem) return this.handleDragEnd();
                
                const targetRow = e.target.closest('tr.draggable-row');
                $$('.drag-over-indicator').forEach(el => el.remove());

                if (targetRow && targetRow !== this.draggedItem) {
                    const rect = targetRow.getBoundingClientRect();
                    const offsetY = e.clientY - rect.top;
                    if (offsetY < rect.height / 2) {
                        targetRow.before(this.draggedItem);
                    } else {
                        targetRow.after(this.draggedItem);
                    }
                } else if (!targetRow && e.target.closest('tbody')) {
                    e.target.closest('tbody').appendChild(this.draggedItem);
                }
                
                this.draggedItem.classList.remove('dragging');
                this.draggedItem = null;

                // Get all rows and update sequence_id
                const rows = $('categories-table-body').querySelectorAll('tr.draggable-row');
                const updatePromises = [];
                
                rows.forEach((row, index) => {
                    const itemId = row.dataset.itemId;
                    const newSequenceId = index + 1; // 1-based indexing
                    
                    const itemInState = state.categories.find(i => i.id == itemId);
                    if (itemInState) itemInState.sequence_id = newSequenceId;
                    
                    updatePromises.push(
                        supabase.from(this.tableName).update({ sequence_id: newSequenceId }).eq('id', itemId)
                    );
                });

                try {
                    renderToast("Saving new sequence...", true, 'info');
                    const results = await Promise.all(updatePromises);
                    const firstError = results.find(res => res.error);
                    if (firstError) throw firstError.error;
                    
                    render.categories(); 
                    renderToast("New order saved!", true, 'info');

                } catch (error) {
                    renderToast(`Error saving sequence: ${error.message}`);
                    await loadInitialData(); // Hard reload from DB on error
                }
            }
        };

        // --- ACTIONS & EVENT HANDLERS ---
        const actions = {
            // --- Menu Tab Actions ---
            viewItemsForCategory(categoryName, brand) {
                state.currentMenuCategory = { name: categoryName, brand: brand };
                render.menu();
            },
            
            backToCategories() {
                state.currentMenuCategory = null;
                render.menu();
            },

            // --- Order Actions ---
            async updateOrderStatus(orderId, status) {
                try {
                    const { error } = await supabase.from('orders').update({ status }).eq('id', orderId);
                    if (error) throw error;
                    // Auto-update reports if order is delivered
                    if (status === 'delivered') {
                        const order = state.liveOrders.find(o => o.id === orderId);
                        if (order) {
                            state.pastOrders.unshift(order);
                            state.liveOrders = state.liveOrders.filter(o => o.id !== orderId);
                            render.reports();
                        }
                    }
                } catch (e) {
                    renderToast(`Error updating order: ${e.message}`);
                }
            },

            async resolveStaffCall(callId) {
                try {
                    const { error } = await supabase.from('staff_calls').update({ status: 'resolved' }).eq('id', callId);
                    if (error) throw error;
                } catch (e) {
                    renderToast(`Error resolving call: ${e.message}`);
                }
            },

            // --- App Settings Actions ---
            async toggleGulabiOrdering(isEnabled) {
                await this.saveSetting('gulabi_ordering_enabled', isEnabled ? 'true' : 'false', `Gulabi Thali ordering successfully set to: ${isEnabled ? 'ON' : 'OFF'}`);
                render.settings();
            },
            
            async saveSettings(e) {
                e.preventDefault();
                const threshold = $('loyalty-threshold-input').value;
                await actions.saveSetting('loyalty_threshold', threshold, 'Loyalty threshold saved!');
            },
            
            // Helper for saving settings
            async saveSetting(key, value, successMessage) {
                 try {
                    const { data: existing, error: fetchError } = await supabase.from('app_settings').select('key').eq('key', key).single();
                    if (fetchError && fetchError.code !== 'PGRST116') throw fetchError;
                    
                    let error;
                    if (existing) {
                        const { error: updateError } = await supabase.from('app_settings').update({ value: value }).eq('key', key);
                        error = updateError;
                    } else {
                        const { error: insertError } = await supabase.from('app_settings').insert({ key: key, value: value });
                        error = insertError;
                    }

                    if (error) throw error;
                    
                    state.appSettings[key] = value;
                    renderToast(successMessage, true, 'info');
                    
                } catch (e) {
                    renderToast(`Error saving setting ${key}: ${e.message}`);
                }
            },

            // --- Item Actions ---
            async toggleItemAvailability(itemId, isAvailable) {
                try {
                    const { error } = await supabase.from('products').update({ is_available: isAvailable }).eq('id', itemId);
                    if (error) throw error;
                    const item = state.menu.find(i => i.id == itemId);
                    if (item) item.is_available = isAvailable;
                } catch (e) {
                    renderToast(`Error updating item: ${e.message}`);
                    render.menu();
                }
            },

            async toggleItemOrderable(itemId, isOrderable) {
                try {
                    const { error } = await supabase.from('products').update({ is_dine_in_orderable: isOrderable }).eq('id', itemId);
                    if (error) throw error;
                    const item = state.menu.find(i => i.id == itemId);
                    if (item) item.is_dine_in_orderable = isOrderable;
                } catch (e) { 
                    renderToast(`Error updating item orderable status: ${e.message}`);
                    render.menu();
                }
            },
            
            // --- Customer Actions ---
            setCustomerFilter(filter) {
                state.customerFilter = filter;
                $$('#customer-filter-tabs .customer-tab').forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.filter === filter);
                });
                render.customers();
            },
            
            downloadCustomerCSV() {
                const filter = state.customerFilter;
                
                // Get the same filtered list that's rendered
                const now = new Date();
                const todayStart = new Date(new Date().setHours(0, 0, 0, 0));
                const sevenDaysAgo = new Date(new Date().setDate(now.getDate() - 7));
                const thirtyDaysAgo = new Date(new Date().setDate(now.getDate() - 30));
                
                const filteredCustomers = state.customers.filter(cust => {
                    const joinedDate = new Date(cust.created_at);
                    switch (filter) {
                        case 'today': return joinedDate >= todayStart;
                        case '7days': return joinedDate >= sevenDaysAgo;
                        case '30days': return joinedDate >= thirtyDaysAgo;
                        case 'all': default: return true;
                    }
                });
                
                if (filteredCustomers.length === 0) {
                    renderToast("No customers to download for this filter.", true, 'info');
                    return;
                }

                // Create CSV content
                let csvContent = "data:text/csv;charset=utf-8,";
                const headers = ["Name", "Phone", "LoyaltyPoints", "JoinedDate"];
                csvContent += headers.join(",") + "\r\n";

                filteredCustomers.forEach(cust => {
                    const name = `"${cust.name.replace(/"/g, '""')}"`; // Handle quotes in name
                    const phone = cust.whatsapp_number || 'N/A';
                    const points = cust.loyalty_points || 0;
                    const joined = new Date(cust.created_at).toISOString().split('T')[0];
                    csvContent += [name, phone, points, joined].join(",") + "\r\n";
                });

                // Trigger download
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `customers_${filter}_${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            },

            // --- MODAL: CATEGORY ---
            showCategoryModal(categoryId = null) {
                const category = categoryId ? state.categories.find(c => c.id == categoryId) : {};
                const isNew = !categoryId;

                const modalHTML = `
                    <h2 class="text-2xl font-bold mb-6">${isNew ? 'Add New Category' : 'Edit Category'}</h2>
                    <form id="category-form" class="space-y-4">
                        <input type="hidden" name="id" value="${category?.id || ''}">
                        
                        <div>
                            <label class="form-label">Category Name</label>
                            <input type="text" name="name" class="form-input" value="${category?.name || ''}" required>
                        </div>
                        
                        <div>
                            <label class="form-label">Emoji</label>
                            <input type="text" name="emoji" class="form-input" value="${category?.emoji || ''}" placeholder="e.g., â˜•ï¸">
                        </div>

                        <div>
                            <label class="form-label">Brand</label>
                            <select name="brand" class="form-input" ${!isNew ? 'disabled' : ''}>
                                <option value="Bulb Cafe" ${category?.brand === 'Bulb Cafe' ? 'selected' : ''}>Bulb Cafe</option>
                                <option value="Gulabi Thali" ${category?.brand === 'Gulabi Thali' ? 'selected' : ''}>Gulabi Thali</option>
                            </select>
                            ${!isNew ? '<p class="text-xs text-gray-500 mt-1">Brand cannot be changed after creation.</p>' : ''}
                        </div>

                        <div class="flex justify-end gap-4 pt-4">
                            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">${isNew ? 'Create Category' : 'Save Changes'}</button>
                        </div>
                    </form>
                `;
                showModal(modalHTML);
                $('category-form').onsubmit = this.saveCategory;
            },

            async saveCategory(e) {
                e.preventDefault();
                const formData = new FormData(e.target);
                const catId = formData.get('id');
                const catData = {
                    name: formData.get('name'),
                    emoji: formData.get('emoji') || null,
                    brand: formData.get('brand'),
                };

                try {
                    let error;
                    if (catId) { // Update
                        // Don't update brand
                        const { error: updateError } = await supabase.from('categories')
                            .update({ name: catData.name, emoji: catData.emoji })
                            .eq('id', catId);
                        error = updateError;
                    } else { // Insert
                        // Get max sequence_id and add 1
                        const { data: maxSeqData, error: maxSeqError } = await supabase.from('categories').select('sequence_id').order('sequence_id', { ascending: false }).limit(1).single();
                        if (maxSeqError) console.warn("Could not get max sequence, defaulting to 99.");
                        catData.sequence_id = (maxSeqData?.sequence_id || 98) + 1;

                        const { error: insertError } = await supabase.from('categories').insert(catData);
                        error = insertError;
                    }
                    if (error) throw error;
                    
                    await loadInitialData();
                    closeModal();
                } catch (e) {
                    renderToast(`Error saving category: ${e.message}`);
                }
            },

            // --- MODAL: MENU ITEM (UPDATED) ---
            showMenuModal(itemId = null) {
                const item = itemId ? state.menu.find(i => i.id == itemId) : {};
                const isNew = !itemId;
                const currentCategory = state.currentMenuCategory;

                // Create category options filtered by the current brand
                const categoryOptions = state.categories
                    .filter(c => c.brand === currentCategory.brand)
                    .map(c => `<option value="${c.name}" ${item?.category === c.name ? 'selected' : ''}>${c.name}</option>`)
                    .join('');

                const modalHTML = `
                    <h2 class="text-2xl font-bold mb-6">${isNew ? 'Add New Item' : 'Edit Menu Item'}</h2>
                    <form id="menu-form" class="space-y-4">
                        <input type="hidden" name="id" value="${item?.id || ''}">
                        
                        <div>
                            <label class="form-label">Name</label>
                            <input type="text" name="name" class="form-input" value="${item?.name || ''}" required>
                        </div>
                        <div>
                            <label class="form-label">Price (â‚¹)</label>
                            <input type="number" name="price" class="form-input" value="${item?.price || 0}" required>
                        </div>
                        <div>
                            <label class="form-label">Category</label>
                            <select name="category" class="form-input" required>
                                <option value="">Select a category</option>
                                ${categoryOptions}
                            </select>
                        </div>
                        <div>
                            <label class="form-label">Description</label>
                            <textarea name="description" class="form-input">${item?.description || ''}</textarea>
                        </div>
                        
                        <!-- This is only shown for Gulabi Thali items -->
                        <div id="orderable-checkbox-container" class="${currentCategory.brand === 'Gulabi Thali' ? '' : 'hidden'}">
                            <label class="form-label flex items-center space-x-2">
                                <input type="checkbox" name="is_dine_in_orderable" class="h-5 w-5 rounded" ${item?.is_dine_in_orderable ? 'checked' : ''}>
                                <span>Dine-in Orderable (for Gulabi Thali)</span>
                            </label>
                        </div>

                        <div class="flex justify-end gap-4 pt-4">
                            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">${isNew ? 'Create Item' : 'Save Changes'}</button>
                        </div>
                    </form>
                `;
                showModal(modalHTML);
                $('menu-form').onsubmit = this.saveMenuItem;
            },
            
            async saveMenuItem(e) {
                e.preventDefault();
                const formData = new FormData(e.target);
                const itemData = Object.fromEntries(formData.entries());
                const currentCategory = state.currentMenuCategory;
                
                // Process form data
                itemData.price = parseFloat(itemData.price);
                itemData.is_dine_in_orderable = formData.get('is_dine_in_orderable') === 'on';
                
                // Set brand from the current viewed category
                itemData.brand = currentCategory.brand;
                
                if (itemData.brand !== 'Gulabi Thali') {
                    itemData.is_dine_in_orderable = false;
                }

                try {
                    let error;
                    if (itemData.id) { // Update
                        delete itemData.id; // Don't send id in update payload
                        const { error: updateError } = await supabase.from('products').update(itemData).eq('id', formData.get('id'));
                        error = updateError;
                    } else { // Insert
                        delete itemData.id;
                        const { error: insertError } = await supabase.from('products').insert(itemData);
                        error = insertError;
                    }
                    if (error) throw error;
                    
                    await loadInitialData(); 
                    render.menu(); // Re-render menu to show new item
                    closeModal();
                } catch (e) {
                    renderToast(`Error saving item: ${e.message}`);
                }
            },
            
            // --- MODAL: CUSTOMER ---
            showCustomerModal(customerId) {
                const cust = state.customers.find(c => c.id == customerId);
                const modalHTML = `
                    <h2 class="text-2xl font-bold mb-6">Edit Customer</h2>
                    <form id="customer-form" class="space-y-4">
                        <input type="hidden" name="id" value="${cust.id}">
                        <div>
                            <label class="form-label">Name</label>
                            <input type="text" name="name" class="form-input" value="${cust.name || ''}" required>
                        </div>
                        <div>
                            <label class="form-label">Phone (10 digits)</label>
                            <input type="tel" name="whatsapp_number" class="form-input" value="${cust.whatsapp_number || ''}" pattern="[0-9]{10}">
                        </div>
                        <div class="flex justify-end gap-4 pt-4">
                            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                        </div>
                    </form>
                `;
                showModal(modalHTML);
                $('customer-form').onsubmit = this.saveCustomer;
            },

            async saveCustomer(e) {
                e.preventDefault();
                const formData = new FormData(e.target);
                const customerId = formData.get('id');
                const updateData = {
                    name: formData.get('name'),
                    whatsapp_number: formData.get('whatsapp_number')
                };

                try {
                    const { data, error } = await supabase.from('customers').update(updateData).eq('id', customerId).select().single();
                    if (error) throw error;
                    
                    const index = state.customers.findIndex(c => c.id == customerId);
                    state.customers[index] = data;
                    render.customers();
                    closeModal();
                } catch (e) {
                    renderToast(`Error updating customer: ${e.message}`);
                }
            },

            // --- MODAL: TABLE ---
            showTableModal(tableId = null) {
                const table = tableId ? state.tables.find(t => t.id == tableId) : {};
                const isNew = !tableId;
                const modalHTML = `
                    <h2 class="text-2xl font-bold mb-6">${isNew ? 'Add New Table' : 'Edit Table'}</h2>
                    <form id="table-form" class="space-y-4">
                        <input type="hidden" name="id" value="${table?.id || ''}">
                        <div>
                            <label class="form-label">Table Number</label>
                            <input type="number" name="table_number" class="form-input" value="${table?.table_number || ''}" required ${!isNew ? 'readonly' : ''} ${!isNew ? 'bg-gray-300' : ''}>
                        </div>
                        <div>
                            <label class="form-label">Description</label>
                            <input type="text" name="description" class="form-input" value="${table?.description || ''}">
                        </div>
                        <div class="flex justify-end gap-4 pt-4">
                            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">${isNew ? 'Create Table' : 'Save Changes'}</button>
                        </div>
                    </form>
                `;
                showModal(modalHTML);
                $('table-form').onsubmit = this.saveTable;
            },

            async saveTable(e) {
                e.preventDefault();
                const formData = new FormData(e.target);
                const tableId = formData.get('id');
                const tableData = {
                    table_number: parseInt(formData.get('table_number')),
                    description: formData.get('description')
                };

                try {
                    let error;
                    if (tableId) { // Update
                        const { error: updateError } = await supabase.from('tables').update({ description: tableData.description }).eq('id', tableId);
                        error = updateError;
                    } else { // Insert
                        const { error: insertError } = await supabase.from('tables').insert(tableData);
                        error = insertError;
                    }
                    if (error) throw error;
                    
                    await loadInitialData(); // Reload all data
                    closeModal();
                } catch (e) {
                    renderToast(`Error saving table: ${e.message}`);
                }
            },

            // --- MODAL: LOYALTY ---
            showLoyaltyModal(customerId, customerName, currentPoints) {
                const modalHTML = `
                    <h2 class="text-2xl font-bold mb-2">Adjust Points</h2>
                    <p class="text-gray-600 mb-6">For: <span class="font-semibold">${customerName}</span> (Current: ${currentPoints})</p>
                    <form id="loyalty-form" class="space-y-4">
                        <input type="hidden" name="id" value="${customerId}">
                        <input type="hidden" name="current_points" value="${currentPoints}">
                        <div>
                            <label class="form-label">Points to Add / Redeem</label>
                            <input type="number" name="adjustment" class="form-input" placeholder="e.g., 50 to add, -20 to redeem" required>
                        </div>
                        <div class="flex justify-end gap-4 pt-4">
                            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Adjust Points</button>
                        </div>
                    </form>
                `;
                showModal(modalHTML);
                $('loyalty-form').onsubmit = this.saveLoyaltyAdjustment;
            },

            async saveLoyaltyAdjustment(e) {
                e.preventDefault();
                const formData = new FormData(e.target);
                const customerId = formData.get('id');
                const adjustment = parseInt(formData.get('adjustment'));

                if (isNaN(adjustment)) {
                    return renderToast("Invalid number for points.");
                }

                try {
                    const { data, error } = await supabase.rpc('adjust_loyalty_points', { customer_id_input: customerId, points_change: adjustment });
                    
                    if (error) throw error;
                    
                    const { data: updatedCustomers, error: fetchError } = await supabase.from('customers').select('*').neq('name', 'Guest').order('name', { ascending: true });
                    if (fetchError) throw fetchError;
                    
                    state.customers = updatedCustomers;
                    render.customers();
                    render.loyalty(); // Re-render loyalty tab
                    closeModal();

                } catch (e) {
                    renderToast(`Error adjusting points: ${e.message}`);
                }
            },

            // --- DELETE CUSTOMER ---
            async deleteCustomer(customerId, customerName) {
                if (confirm(`Are you sure you want to delete ${customerName} (ID: ${customerId})?\nThis will also delete ALL of their past orders.\nTHIS ACTION CANNOT BE UNDONE.`)) {
                    try {
                        // 1. First, delete all associated orders (order_items will cascade delete)
                        const { error: orderError } = await supabase.from('orders').delete().eq('customer_id', customerId);
                        if (orderError) throw new Error(`Could not delete associated orders: ${orderError.message}`);

                        // 2. Now, delete the customer
                        const { error } = await supabase.from('customers').delete().eq('id', customerId);
                        if (error) throw error;
                        
                        state.customers = state.customers.filter(c => c.id != customerId);
                        render.customers();
                        render.loyalty();
                        render.reports();
                    } catch (e) {
                         renderToast(`Error deleting customer: ${e.message}.`);
                    }
                }
            },

            async deleteOrder(orderId, customerName) {
                if (confirm(`Are you sure you want to delete this order from ${customerName} (ID: ${orderId})?\nThis will also delete all associated order items.\nTHIS ACTION CANNOT BE UNDONE.`)) {
                    try {
                        const { error } = await supabase.from('orders').delete().eq('id', orderId);
                        if (error) throw error;
                        
                        state.pastOrders = state.pastOrders.filter(o => o.id != orderId);
                        render.history();
                        render.reports();
                    } catch (e) {
                         renderToast(`Error deleting order: ${e.message}.`);
                    }
                }
            }
        };

        // --- GLOBAL MODAL CONTROLS ---
        function showModal(html) {
            const container = $('modal-container');
            container.innerHTML = `<div class="modal-overlay" onclick="closeModal()"><div class="modal-content" onclick="event.stopPropagation();">${html}</div></div>`;
            container.classList.remove('hidden');
        }
        function closeModal() {
            const container = $('modal-container');
            container.classList.add('hidden');
            container.innerHTML = '';
        }

        // --- GLOBAL EVENT BINDINGS ---
        $('login-form').onsubmit = (e) => {
            e.preventDefault();
            const email = $('email').value;
            const password = $('password').value;
            auth.login(email, password);
        };

        $('logout-button').onclick = () => auth.logout();

        $('nav-links').onclick = (e) => {
            const navLink = e.target.closest('.nav-link');
            if (navLink) {
                const tab = navLink.dataset.tab;
                
                $$('.nav-link').forEach(link => link.classList.remove('active'));
                navLink.classList.add('active');
                
                $$('.tab-content').forEach(content => content.classList.remove('active'));
                $(`${tab}-tab`).classList.add('active');

                // Reset menu view when clicking menu tab
                if (tab === 'menu') {
                    actions.backToCategories();
                }
            }
        };

        // Updated Add Item button
        $('add-item-btn').onclick = () => actions.showMenuModal();
        $('back-to-categories-btn').onclick = () => actions.backToCategories();
        $('add-category-btn').onclick = () => actions.showCategoryModal();
        $('add-table-btn').onclick = () => actions.showTableModal();
        
        // NEW: Customer filter tab listeners
        $('customer-filter-tabs').onclick = (e) => {
            const tab = e.target.closest('.customer-tab');
            if (tab && !tab.classList.contains('active')) {
                actions.setCustomerFilter(tab.dataset.filter);
            }
        };
        
        // NEW: Download CSV listener
        $('download-csv-btn').onclick = () => actions.downloadCustomerCSV();
        
        // NEW: Settings form listener
        $('settings-form').onsubmit = (e) => actions.saveSettings(e);

        window.actions = actions;
        window.closeModal = closeModal;
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bulb Cafe Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <style>
        :root {
            --bg-light: #f3f4f6;
            --bg-white: #ffffff;
            --text-dark: #1f2937;
            --text-gray: #6b7280;
            --border-light: #e5e7eb;
            --brand-yellow: #f59e0b;
            --brand-pink: #db2777;
            --brand-blue: #3b82f6;
            --accent-red: #ef4444;
            --accent-green: #22c55e;
        }
        body {
            background-color: var(--bg-light);
            color: var(--text-dark);
            font-family: 'Poppins', sans-serif;
        }
        .card {
            background-color: var(--bg-white);
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
            border: 1px solid var(--border-light);
        }
        /* Side Nav Link */
        .nav-link {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            color: var(--text-gray);
            transition: all 0.2s ease;
        }
        .nav-link.active {
            background-color: var(--brand-yellow);
            color: var(--bg-white);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .nav-link:not(.active):hover {
            background-color: var(--bg-light);
            color: var(--text-dark);
        }
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn-primary {
            background-color: var(--brand-blue);
            color: var(--bg-white);
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .btn-secondary {
            background-color: var(--bg-light);
            color: var(--text-dark);
            border: 1px solid var(--border-light);
        }
        .btn-secondary:hover {
            background-color: #e5e7eb;
        }
        .btn-danger {
            background-color: var(--accent-red);
            color: var(--bg-white);
        }
        .btn-danger:hover {
            background-color: #dc2626;
        }
        .btn-success {
            background-color: var(--accent-green);
            color: var(--bg-white);
        }
        .btn-success:hover {
            background-color: #16a34a;
        }
        .btn-sm {
            padding: 0.25rem 0.75rem;
            font-size: 0.875rem;
        }
        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .modal-content {
            background-color: var(--bg-white);
            padding: 1.5rem;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);
        }
        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-light);
            border-radius: 0.5rem;
            background-color: var(--bg-light);
        }
        .form-input:focus {
            outline: 2px solid var(--brand-blue);
            background-color: var(--bg-white);
        }
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-dark);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .order-card-new {
            animation: pulse-new 2s infinite;
        }
        @keyframes pulse-new {
            0%, 100% { box-shadow: 0 0 0 0 rgba(245, 159, 11, 0.7); }
            50% { box-shadow: 0 0 0 6px rgba(245, 159, 11, 0); }
        }
        .call-card-new {
            animation: pulse-call 2s infinite;
        }
        @keyframes pulse-call {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            50% { box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); }
        }
        
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body class="min-h-screen">

    <!-- Global Error Toast -->
    <div id="error-toast" class="hidden fixed top-4 right-4 z-[100] bg-red-600 text-white p-4 rounded-lg shadow-lg">
        <p id="error-message"></p>
    </div>
    
    <!-- Global Success Toast -->
    <div id="success-toast" class="hidden fixed top-4 right-4 z-[100] bg-green-600 text-white p-4 rounded-lg shadow-lg">
        <p id="success-message"></p>
    </div>

    <!-- Login Screen -->
    <div id="login-screen" class="flex items-center justify-center min-h-screen">
        <div class="card w-full max-w-sm p-8">
            <h1 class="text-3xl font-bold text-center mb-2" style="color: var(--brand-yellow);">BULB ADMIN</h1>
            <p class="text-center text-gray-600 mb-6">Please sign in to continue</p>
            <form id="login-form">
                <div class="mb-4">
                    <label for="email" class="form-label">Email</label>
                    <input type="email" id="email" class="form-input" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="form-label">Password</label>
                    <input type="password" id="password" class="form-input" required>
                </div>
                <button type="submit" id="login-button" class="btn btn-primary w-full py-3">
                    Sign In
                </button>
            </form>
        </div>
    </div>

    <!-- Main App Interface -->
    <div id="app" class="hidden flex h-screen">
        
        <!-- Sidebar -->
        <aside class="w-60 bg-white shadow-lg flex flex-col h-full flex-shrink-0 border-r border-gray-200">
            <div class="p-4 h-16 flex items-center border-b border-gray-200">
                <span class="text-2xl font-bold" style="color: var(--brand-yellow);">ðŸ’¡ BULB ADMIN</span>
            </div>
            <nav id="nav-links" class="flex flex-col space-y-2 p-4">
                <!-- NEW: Dashboard Tab -->
                <button class="nav-link" data-tab="dashboard">
                    <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 0 0 6 16.5h2.25M3.75 3h-1.5m1.5 0h16.5m0 0h1.5m-1.5 0v11.25A2.25 2.25 0 0 1 18 16.5h-2.25m-7.5 0h7.5m-7.5 0-1 3m1-3 1 3m0 0-1 3m1-3 1 3m0 0h-3.75m6.75-3h-3.75z" /></svg>
                    Dashboard
                </button>
                <!-- NEW: Live Kitchen Tab (was Dashboard) -->
                <button class="nav-link active" data-tab="live-kitchen">
                    <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 21h-5.625A2.25 2.25 0 0113.125 18.75V16.5A2.25 2.25 0 0115.375 14.25H18a2.25 2.25 0 012.25 2.25V18.75A2.25 2.25 0 0118 21H5.25A2.25 2.25 0 013 18.75V16.5A2.25 2.25 0 015.25 14.25H7.5A2.25 2.25 0 019.75 16.5V18.75A2.25 2.25 0 017.5 21H3m0 0h18M12 6.75h.008v.008H12V6.75z" /></svg>
                    Live Kitchen
                </button>
                <button class="nav-link" data-tab="history">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Order History
                </button>
                <button class="nav-link" data-tab="menu">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
                    Menu
                </button>
                <button class="nav-link" data-tab="customers">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                    Customers
                </button>
                <button class="nav-link" data-tab="tables">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h6m-6 4h6m-6 4h6"></path></svg>
                    Tables
                </button>
                <button class="nav-link" data-tab="qr">
                    <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 4.5v15h15V18m-15-3.75h15m-15-3.75h15M3.75 4.5h15v3.75m-15 9V4.5m0 15h3.75m-3.75 0V18m0 0h3.75m0 0v3.75m0-3.75h3.75m0 0v3.75M7.5 18h3.75m0 0v3.75m0-3.75h3.75M11.25 18v3.75m0-3.75h3.75m0 0v3.75m0-3.75h3.75m0 0v3.75M15 18h3.75m0 0v3.75m0-3.75h3.75m0 0V18m0 0h-3.75m0 0V18m0 0h-3.75m0 0V18m0 0h-3.75m0 0V18m0 0h-3.75M15 18h-3.75m0 0v-3.75m0 0h-3.75m0 0V18m0 0H7.5m0 0v-3.75m0 0h3.75M11.25 14.25h3.75m0 0v-3.75m0 0h-3.75m0 0v3.75m0 0H11.25m0 0V10.5M7.5 10.5v3.75m0 0h3.75m0 0V10.5m0 0H7.5m0 0V6.75m0 0h3.75M11.25 6.75h3.75m0 0v3.75m0 0h-3.75m0 0V6.75m0 0H11.25m3.75 3.75h3.75m0 0v3.75m0 0h-3.75m0 0v-3.75m0 0h3.75M15 14.25v-3.75" /></svg>
                    QR Generator
                </button>
                <button class="nav-link" data-tab="analytics">
                    <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 0 0 6 16.5h2.25M3.75 3h-1.5m1.5 0h16.5m0 0h1.5m-1.5 0v11.25A2.25 2.25 0 0 1 18 16.5h-2.25m-7.5 0h7.5m-7.5 0-1 3m1-3 1 3m0 0-1 3m1-3 1 3m0 0h-3.75m6.75-3h-3.75z" /></svg>
                    Analytics
                </button>
                <button class="nav-link" data-tab="reports">
                    <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
                    Reports
                </button>
                <button class="nav-link" data-tab="settings">
                    <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.343 3.94c.09-.542.56-1.007 1.11-1.226m-2.22 0a2.25 2.25 0 0 0-2.22 2.22v.946c0 .329-.055.658-.168.975a.75.75 0 0 1-1.472.235A2.25 2.25 0 0 0 5.25 6.75H3.75a2.25 2.25 0 0 0-2.25 2.25v.946c0 .329.055.658.168.975a.75.75 0 0 1-1.472.235A2.25 2.25 0 0 0 .75 13.25v1.5c0 .621.504 1.125 1.125 1.125h1.5a2.25 2.25 0 0 0 2.25-2.25v-.946c0-.329.055-.658.168-.975a.75.75 0 0 1 1.472-.235A2.25 2.25 0 0 0 9.75 13.25h4.5a2.25 2.25 0 0 0 2.25-2.25v-.946c0-.329-.055-.658-.168-.975a.75.75 0 0 1 1.472-.235A2.25 2.25 0 0 0 18.75 11.25h1.5a2.25 2.25 0 0 0 2.25-2.25v-1.5a2.25 2.25 0 0 0-2.25-2.25h-1.5a2.25 2.25 0 0 0-2.25 2.25v.946c0 .329-.055.658-.168.975a.75.75 0 0 1-1.472-.235A2.25 2.25 0 0 0 14.25 6.75h-4.5a2.25 2.25 0 0 0-2.25 2.25v.946c0 .329.055.658.168.975a.75.75 0 0 1-1.472.235A2.25 2.25 0 0 0 5.25 11.25H3.75a2.25 2.25 0 0 0-2.25 2.25v1.5c0 .621.504 1.125 1.125 1.125h1.5a2.25 2.25 0 0 0 2.25-2.25v-.946a.75.75 0 0 1 .168-.975.75.75 0 0 1 1.472-.235a2.25 2.25 0 0 0 2.25 2.25h4.5a2.25 2.25 0 0 0 2.25-2.25v-.946a.75.75 0 0 1 .168-.975.75.75 0 0 1 1.472-.235a2.25 2.25 0 0 0 2.25 2.25h1.5a2.25 2.25 0 0 0 2.25-2.25v-1.5a2.25 2.25 0 0 0-2.25-2.25h-1.5a2.25 2.25 0 0 0-2.25 2.25v.946c0 .329-.055.658-.168.975a.75.75 0 0 1-1.472-.235A2.25 2.25 0 0 0 14.25 13.25h-4.5a2.25 2.25 0 0 0-2.25-2.25v-.946a.75.75 0 0 1-.168-.975.75.75 0 0 1-1.472.235A2.25 2.25 0 0 0 5.25 6.75H3.75a2.25 2.25 0 0 0-2.25 2.25v.946c0 .329.055.658.168.975a.75.75 0 0 1-1.472.235A2.25 2.25 0 0 0 .75 11.25v-1.5a2.25 2.25 0 0 0 2.25-2.25h1.5A2.25 2.25 0 0 0 6.75 9v-.946a2.25 2.25 0 0 0-2.25-2.25H3.75z" /></svg>
                    Settings
                </button>
            </nav>
            <div class="mt-auto p-4">
                <button id="logout-button" class="btn btn-secondary w-full">Logout</button>
            </div>
        </aside>

        <!-- Main Content Area -->
        <div class="flex-1 flex flex-col overflow-y-auto">
            <!-- Top bar for user -->
            <header class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-40">
                <div class="flex justify-end items-center h-16 px-4 sm:px-6 lg:px-8">
                    <span id="admin-email" class="text-gray-700 font-medium mr-4"></span>
                    <!-- Logout button moved to sidebar -->
                </div>
            </header>

            <main class="p-4 sm:p-6 lg:p-8">
                <!-- NEW: Dashboard -->
                <div id="dashboard-tab" class="tab-content">
                     <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="stats-container">
                        <!-- Stats will be injected here -->
                        <div class="card p-6">
                            <h3 class="text-sm font-medium text-gray-500">Today's Gross Revenue</h3>
                            <p class="text-3xl font-bold text-gray-900 mt-1">â‚¹0.00</p>
                        </div>
                        <div class="card p-6">
                            <h3 class="text-sm font-medium text-gray-500">Today's Net Revenue</h3>
                            <p class="text-3xl font-bold text-gray-900 mt-1">â‚¹0.00</p>
                        </div>
                        <div class="card p-6">
                            <h3 class="text-sm font-medium text-gray-500">Today's Total Orders</h3>
                            <p class="text-3xl font-bold text-gray-900 mt-1">0</p>
                        </div>
                    </div>
                    <div class="mt-8">
                        <h2 class="text-2xl font-bold text-gray-800">Live Staff Calls</h2>
                        <div id="staff-calls-container" class="space-y-4 mt-4">
                            <!-- Staff calls will be injected here -->
                            <div id="no-calls-msg" class="text-gray-500 card p-4">No pending staff calls.</div>
                        </div>
                    </div>
                </div>

                <!-- NEW: Live Kitchen (was Dashboard) -->
                <div id="live-kitchen-tab" class="tab-content active">
                    <!-- FIX: Changed to 2 columns -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Received -->
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800 mb-4 pb-2 border-b-4 border-yellow-500">Received</h2>
                            <div id="kitchen-col-received" class="space-y-4 h-[calc(100vh-200px)] overflow-y-auto p-2 bg-gray-100 rounded-lg">
                                <div id="no-orders-msg" class="text-gray-500 text-center p-4">No new orders.</div>
                                <!-- Received Orders -->
                            </div>
                        </div>
                        <!-- Preparing -->
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800 mb-4 pb-2 border-b-4 border-blue-500">Preparing</h2>
                            <div id="kitchen-col-preparing" class="space-y-4 h-[calc(100vh-200px)] overflow-y-auto p-2 bg-gray-100 rounded-lg">
                                <!-- Preparing Orders -->
                            </div>
                        </div>
                        <!-- FIX: Removed "Ready for Pickup" column -->
                    </div>
                </div>

                <!-- Order History -->
                <div id="history-tab" class="tab-content space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800">Order History</h2>
                    <div class="card p-4 overflow-x-auto">
                        <table class="w-full min-w-max">
                            <thead class="border-b border-gray-200">
                                <tr>
                                    <th class="p-2 text-left font-semibold text-gray-600">Date & Time</th>
                                    <th class="p-2 text-left font-semibold text-gray-600">Customer</th>
                                    <th class="p-2 text-left font-semibold text-gray-600">Table</th>
                                    <th class="p-2 text-left font-semibold text-gray-600">Total</th>
                                    <th class="p-2 text-left font-semibold text-gray-600">Status</th>
                                    <th class="p-2 text-right font-semibold text-gray-600">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="history-table-body">
                                <!-- History will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Menu Management -->
                <div id="menu-tab" class="tab-content space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-800">Menu Management</h2>
                        <button id="add-item-btn" class="btn btn-primary">Add New Item</button>
                    </div>
                    <div class="card p-4 overflow-x-auto">
                        <table class="w-full min-w-max">
                            <thead class="border-b border-gray-200">
                                <tr>
                                    <th class="p-2 text-left font-semibold text-gray-600">Name</th>
                                    <th class="p-2 text-left font-semibold text-gray-600">Price</th>
                                    <th class="p-2 text-left font-semibold text-gray-600">Category</th>
                                    <th class="p-2 text-left font-semibold text-gray-600">Brand</th>
                                    <th class="p-2 text-left font-semibold text-gray-600">Available</th>
                                    <th class="p-2 text-right font-semibold text-gray-600">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="menu-table-body">
                                <!-- Menu items will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Customer Management -->
                <div id="customers-tab" class="tab-content space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800">Customer Management</h2>
                    <div class="card p-4 overflow-x-auto">
                        <table class="w-full min-w-max">
                            <thead class="border-b border-gray-200">
                                <tr>
                                    <th class="p-2 text-left font-semibold text-gray-600">Name</th>
                                    <th class="p-2 text-left font-semibold text-gray-600">Phone</th>
                                    <th class="p-2 text-left font-semibold text-gray-600">Loyalty Points</th>
                                    <th class="p-2 text-right font-semibold text-gray-600">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="customers-table-body">
                                <!-- Customers will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Table Management -->
                <div id="tables-tab" class="tab-content space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-800">Table Management</h2>
                        <button id="add-table-btn" class="btn btn-primary">Add New Table</button>
                    </div>
                    <div class="card p-4 overflow-x-auto">
                        <table class="w-full min-w-max">
                            <thead class="border-b border-gray-200">
                                <tr>
                                    <th class="p-2 text-left font-semibold text-gray-600">Table #</th>
                                    <th class="p-2 text-left font-semibold text-gray-600">Description</th>
                                    <th class="p-2 text-right font-semibold text-gray-600">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="tables-table-body">
                                <!-- Tables will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- QR Generator -->
                <div id="qr-tab" class="tab-content">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Table QR Codes (1-10)</h2>
                        <button onclick="window.print()" class="btn btn-primary">Print All</button>
                    </div>
                    <div id="qr-code-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6">
                        <!-- QR codes will be injected here -->
                    </div>
                </div>
                
                <!-- NEW: Analytics -->
                <div id="analytics-tab" class="tab-content space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800">Analytics</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="analytics-stats-container">
                        <!-- Analytics stats will be injected here -->
                    </div>
                    <div class="card p-4">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Top 5 Selling Items</h3>
                        <div id="analytics-top-items-container">
                            <!-- Top items will be injected here -->
                        </div>
                    </div>
                </div>
                
                <!-- NEW: Reports -->
                <div id="reports-tab" class="tab-content space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800">Reports</h2>
                    <div class="card p-6 space-y-4">
                        <p class="text-gray-600">Download your store data in CSV format.</p>
                        <div class="flex flex-col md:flex-row gap-4">
                            <button class="btn btn-primary" onclick="actions.exportOrderHistoryCSV()">
                                <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
                                Export Order History
                            </button>
                            <button class="btn btn-primary" onclick="actions.exportCustomerListCSV()">
                                <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
                                Export Customer List
                            </button>
                            <button class="btn btn-primary" onclick="actions.exportMenuCSV()">
                                <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
                                Export Menu
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- NEW: Settings -->
                <div id="settings-tab" class="tab-content space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800">App Settings</h2>
                    <div class="card p-6">
                        <div id="settings-container" class="space-y-6">
                            <!-- Settings will be injected here -->
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal Container -->
    <div id="modal-container" class="hidden"></div>

    <script type="module">
        // --- SUPABASE CONFIG ---
        const SUPABASE_URL = 'https://vrvlvvlfzbdqwfsdlrkv.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZydmx2dmxmemJkcXdmc2Rscmt2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5NzI2NzAsImV4cCI6MjA3NzU0ODY3MH0.yYnxeipLuO0DlTvGITI5ajHDeoWZ80N2PS3rPhuOyp8';
        let supabase = null;

        // --- NOTIFICATION SOUND ---
        const NOTIFICATION_URL = 'https://vrvlvvlfzbdqwfsdlrkv.supabase.co/storage/v1/object/public/video/new-notification-022-370046.mp3';
        let audioContext;
        let audioBuffer;
        let hasInteracted = false;

        async function initAudio() {
            if (audioContext) return;
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const response = await fetch(NOTIFICATION_URL);
                const arrayBuffer = await response.arrayBuffer();
                audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                console.log("Audio initialized");
            } catch (e) {
                console.error("Error initializing audio:", e);
            }
        }

        function playNotification() {
            if (!audioContext || !audioBuffer) {
                console.warn("Audio not ready.");
                return;
            }
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            const source = audioContext.createBufferSource();
            source.buffer = audioBuffer;
            source.connect(audioContext.destination);
            source.start(0);
        }
        
        // --- APP STATE ---
        const state = {
            user: null,
            kitchenOrders: [], // RENAMED
            pastOrders: [],
            dashboardStats: { gross: 0, net: 0, count: 0 }, // NEW
            staffCalls: [],
            menu: [],
            customers: [],
            tables: [],
            appSettings: [],
            
            kitchenOrderSubscription: null, // RENAMED
            mainOrderSubscription: null, // NEW: For all order changes (analytics, history)
            callSubscription: null,
            menuSubscription: null,
            customerSubscription: null,
            tableSubscription: null,
            settingsSubscription: null,
        };

        // --- DOM SELECTORS ---
        const $ = (id) => document.getElementById(id);
        const $$ = (sel) => document.querySelectorAll(sel);

        // --- TOAST/ERROR HANDLING ---
        function showToast(message, type = 'success') {
            const toast = type === 'success' ? $('success-toast') : $('error-toast');
            const msgEl = type === 'success' ? $('success-message') : $('error-message');
            
            if (!toast || !msgEl) return;
            
            msgEl.textContent = message;
            toast.classList.remove('hidden');

            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        function renderError(message, autoHide = true) {
            console.error(message);
            showToast(message, 'error');
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            try {
                const { createClient } = window.supabase;
                if (!createClient) {
                    throw new Error("Supabase client library not found on window.supabase.");
                }
                supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log("Supabase client initialized.");
                
                auth.checkSession();
            } catch (e) {
                console.error("CRITICAL: SUPABASE initialization failed.", e);
                renderError(`CRITICAL: App failed to start. ${e.message}`, false);
            }
        });


        // --- AUTHENTICATION ---
        const auth = {
            async checkSession() {
                try {
                    const { data, error } = await supabase.auth.getSession();
                    if (error) throw error;
                    
                    if (data.session) {
                        state.user = data.session.user;
                        this.showApp();
                        document.body.addEventListener('click', () => {
                            if (!hasInteracted) {
                                initAudio();
                                hasInteracted = true;
                            }
                        }, { once: true });
                    } else {
                        this.showLogin();
                    }
                } catch (e) {
                    renderError(`Auth Error: ${e.message}`);
                    this.showLogin();
                }
            },
            async login(email, password) {
                const btn = $('login-button');
                btn.disabled = true;
                btn.innerHTML = '<div class="spinner"></div>';
                
                const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                
                btn.disabled = false;
                btn.innerHTML = 'Sign In';
                
                if (error) {
                    renderError(error.message);
                } else {
                    state.user = data.user;
                    this.showApp();
                    document.body.addEventListener('click', initAudio, { once: true });
                }
            },
            async logout() {
                await supabase.auth.signOut();
                state.user = null;
                // Stop all listeners
                listeners.stopAll();
                this.showLogin();
            },
            showLogin() {
                $('login-screen').classList.remove('hidden');
                $('app').classList.add('hidden');
            },
            async showApp() {
                $('login-screen').classList.add('hidden');
                $('app').classList.remove('hidden');
                $('admin-email').textContent = state.user.email;
                
                await loadInitialData();
                
                // Start all real-time listeners
                listeners.startAll();
            }
        };

        // --- DATA LOADING ---
        async function loadInitialData() {
            try {
                // FIX: Removed 'ready' from kitchen orders query
                const [pastOrdersRes, kitchenOrdersRes, callsRes, menuRes, customersRes, tablesRes, settingsRes] = await Promise.all([
                    supabase.from('orders').select('*, tables(table_number), customers(name), order_items(*, products(name))').in('status', ['delivered', 'cancelled']).order('created_at', { ascending: false }),
                    supabase.from('orders').select('*, tables(table_number), customers(name), order_items(*, products(name))').in('status', ['received', 'preparing']).order('created_at', { ascending: true }),
                    supabase.from('staff_calls').select('*').eq('status', 'pending').order('created_at', { ascending: true }),
                    supabase.from('products').select('*').order('name', { ascending: true }),
                    supabase.from('customers').select('*').order('name', { ascending: true }),
                    supabase.from('tables').select('*').order('table_number', { ascending: true }),
                    supabase.from('app_settings').select('*').order('key', { ascending: true })
                ]);

                if (pastOrdersRes.error) throw pastOrdersRes.error;
                if (kitchenOrdersRes.error) throw kitchenOrdersRes.error;
                if (callsRes.error) throw callsRes.error;
                if (menuRes.error) throw menuRes.error;
                if (customersRes.error) throw customersRes.error;
                if (tablesRes.error) throw tablesRes.error;
                if (settingsRes.error) throw settingsRes.error;

                state.pastOrders = pastOrdersRes.data;
                state.kitchenOrders = kitchenOrdersRes.data;
                state.staffCalls = callsRes.data;
                state.menu = menuRes.data;
                state.customers = customersRes.data;
                state.tables = tablesRes.data;
                state.appSettings = settingsRes.data;
                
                await dataHelpers.loadDashboardStats(); // Calculate stats from loaded past orders

                render.all();

            } catch (error) {
                renderError(`Error Loading Data: ${error.message}\nThis is likely an RLS (Row Level Security) issue.\nYour RLS policies are probably blocking this admin account from viewing all data. You must update your policies in the Supabase dashboard to grant full access to this logged-in user.`);
                console.error("Detailed Load Error:", error);
            }
        }

        // --- NEW: Data Helpers ---
        const dataHelpers = {
            // Gets today's date in YYYY-MM-DD format for Supabase
            getTodayString() {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            },

            // Calculates stats for the new dashboard
            async loadDashboardStats() {
                const today = this.getTodayString();
                
                // Fetch today's delivered orders
                const { data, error } = await supabase.from('orders')
                    .select('final_amount, discount_amount, order_items(price_at_time_of_order, quantity)')
                    .eq('status', 'delivered')
                    .gte('created_at', `${today}T00:00:00.000Z`)
                    .lte('created_at', `${today}T23:59:59.999Z`);
                
                if (error) {
                    console.error("Error fetching dashboard stats:", error);
                    return;
                }
                
                let gross = 0;
                let net = 0;
                
                data.forEach(order => {
                    // Net is the final amount customer paid
                    net += order.final_amount || 0;
                    
                    // Gross is net + discount, OR sum of items
                    let orderSubtotal = (order.order_items || []).reduce((sum, item) => sum + (item.price_at_time_of_order * item.quantity), 0);
                    gross += orderSubtotal;
                });
                
                state.dashboardStats = {
                    gross: gross,
                    net: net,
                    count: data.length
                };
                
                // Re-render the dashboard stats
                render.dashboard();
            }
        };
        
        // --- ACTIONS & EVENT HANDLERS --- (MOVED HERE)
        const actions = {
            async updateOrderStatus(orderId, status) {
                // The real-time listener will handle all UI changes.
                // This function just sends the command.
                try {
                    const { error } = await supabase.from('orders').update({ status }).eq('id', orderId);
                    if (error) {
                        throw error;
                    }
                    showToast(`Order update sent: ${status}.`);
                    // Real-time listener will fire and update the UI.
                } catch (e) {
                    renderError(`Error updating order: ${e.message}`);
                }
            },

            async resolveStaffCall(callId) {
                try {
                    const { error } = await supabase.from('staff_calls').update({ status: 'resolved' }).eq('id', callId);
                    if (error) throw error;
                    showToast('Staff call resolved.');
                    // Real-time listener will handle the UI update
                } catch (e) {
                    renderError(`Error resolving call: ${e.message}`);
                }
            },

            async toggleItemAvailability(itemId, isAvailable) {
                try {
                    const { error } = await supabase.from('products').update({ is_available: isAvailable }).eq('id', itemId);
                    if (error) throw error;
                    showToast(`Item availability updated.`);
                    // Real-time listener will handle the UI update
                } catch (e) {
                    renderError(`Error updating item: ${e.message}`);
                    render.menu(); // Revert checkbox on failure
                }
            },

            // --- MODAL: MENU ITEM ---
            showMenuModal(itemId = null) {
                const item = itemId ? state.menu.find(i => i.id === itemId) : {};
                const isNew = !itemId;
                const modalHTML = `
                    <h2 class="text-2xl font-bold mb-6">${isNew ? 'Add New Item' : 'Edit Menu Item'}</h2>
                    <form id="menu-form" class="space-y-4">
                        <input type="hidden" name="id" value="${item?.id || ''}">
                        <div>
                            <label class="form-label">Name</label>
                            <input type="text" name="name" class="form-input" value="${item?.name || ''}" required>
                        </div>
                        <div>
                            <label class="form-label">Price (â‚¹)</label>
                            <input type="number" name="price" class="form-input" value="${item?.price || 0}" required>
                        </div>
                        <div>
                            <label class="form-label">Category</label>
                            <input type="text" name="category" class="form-input" value="${item?.category || ''}" required>
                        </div>
                        <div>
                            <label class="form-label">Brand</label>
                            <select name="brand" class="form-input">
                                <option value="Bulb Cafe" ${item?.brand === 'Bulb Cafe' ? 'selected' : ''}>Bulb Cafe</option>
                                <option value="Gulabi Thali" ${item?.brand === 'Gulabi Thali' ? 'selected' : ''}>Gulabi Thali</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">Description</label>
                            <textarea name="description" class="form-input">${item?.description || ''}</textarea>
                        </div>
                        <div class="flex justify-end gap-4 pt-4">
                            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">${isNew ? 'Create Item' : 'Save Changes'}</button>
                        </div>
                    </form>
                `;
                showModal(modalHTML);
                $('menu-form').onsubmit = this.saveMenuItem;
            },

            async saveMenuItem(e) {
                e.preventDefault();
                const formData = new FormData(e.target);
                const itemData = Object.fromEntries(formData.entries());
                itemData.price = parseFloat(itemData.price);
                
                try {
                    let error;
                    if (itemData.id) { // Update
                        const { error: updateError } = await supabase.from('products').update(itemData).eq('id', itemData.id);
                        error = updateError;
                    } else { // Insert
                        delete itemData.id;
                        const { error: insertError } = await supabase.from('products').insert([itemData]);
                        error = insertError;
                    }
                    if (error) throw error;
                    
                    showToast(itemData.id ? 'Item updated!' : 'Item created!');
                    closeModal();
                } catch (e) {
                    renderError(`Error saving item: ${e.message}`);
                }
            },
            
            // --- MODAL: CUSTOMER ---
            showCustomerModal(customerId) {
                const cust = state.customers.find(c => c.id === customerId);
                const modalHTML = `
                    <h2 class="text-2xl font-bold mb-6">Edit Customer</h2>
                    <form id="customer-form" class="space-y-4">
                        <input type="hidden" name="id" value="${cust.id}">
                        <div>
                            <label class="form-label">Name</label>
                            <input type="text" name="name" class="form-input" value="${cust.name || ''}" required>
                        </div>
                        <div>
                            <label class="form-label">Phone (10 digits)</label>
                            <input type="tel" name="whatsapp_number" class="form-input" value="${cust.whatsapp_number || ''}" pattern="[0-9]{10}">
                        </div>
                        <div class="flex justify-end gap-4 pt-4">
                            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                        </div>
                    </form>
                `;
                showModal(modalHTML);
                $('customer-form').onsubmit = this.saveCustomer;
            },

            async saveCustomer(e) {
                e.preventDefault();
                const formData = new FormData(e.target);
                const customerId = formData.get('id');
                const updateData = {
                    name: formData.get('name'),
                    whatsapp_number: formData.get('whatsapp_number')
                };

                try {
                    const { data, error } = await supabase.from('customers').update(updateData).eq('id', customerId);
                    if (error) throw error;
                    
                    showToast('Customer updated!');
                    closeModal();
                } catch (e) {
                    renderError(`Error updating customer: ${e.message}`);
                }
            },

            // --- MODAL: TABLE ---
            showTableModal(tableId = null) {
                const table = tableId ? state.tables.find(t => t.id === tableId) : {};
                const isNew = !tableId;
                const modalHTML = `
                    <h2 class="text-2xl font-bold mb-6">${isNew ? 'Add New Table' : 'Edit Table'}</h2>
                    <form id="table-form" class="space-y-4">
                        <input type="hidden" name="id" value="${table?.id || ''}">
                        <div>
                            <label class="form-label">Table Number</label>
                            <input type="number" name="table_number" class="form-input" value="${table?.table_number || ''}" required ${!isNew ? 'readonly class="bg-gray-200"' : ''}>
                        </div>
                        <div>
                            <label class="form-label">Description</label>
                            <input type="text" name="description" class="form-input" value="${table?.description || ''}">
                        </div>
                        <div class="flex justify-end gap-4 pt-4">
                            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">${isNew ? 'Create Table' : 'Save Changes'}</button>
                        </div>
                    </form>
                `;
                showModal(modalHTML);
                $('table-form').onsubmit = this.saveTable;
            },

            async saveTable(e) {
                e.preventDefault();
                const formData = new FormData(e.target);
                const tableId = formData.get('id');
                const tableData = {
                    table_number: parseInt(formData.get('table_number')),
                    description: formData.get('description')
                };

                try {
                    let error;
                    if (tableId) { // Update
                        const { error: updateError } = await supabase.from('tables').update({ description: tableData.description }).eq('id', tableId);
                        error = updateError;
                    } else { // Insert
                        const { error: insertError } = await supabase.from('tables').insert([tableData]);
                        error = insertError;
                    }
                    if (error) throw error;
                    
                    showToast(tableId ? 'Table updated!' : 'Table created!');
                    closeModal();
                } catch (e) {
                    renderError(`Error saving table: ${e.message}`);
                }
            },

            // --- MODAL: LOYALTY ---
            showLoyaltyModal(customerId, customerName, currentPoints) {
                const modalHTML = `
                    <h2 class="text-2xl font-bold mb-2">Adjust Points</h2>
                    <p class="text-gray-600 mb-6">For: <span class="font-semibold">${customerName}</span> (Current: ${currentPoints})</p>
                    <form id="loyalty-form" class="space-y-4">
                        <input type="hidden" name="id" value="${customerId}">
                        <div>
                            <label class="form-label">Points to Add / Redeem</label>
                            <input type="number" name="adjustment" class="form-input" placeholder="e.g., 50 to add, -20 to redeem" required>
                        </div>
                        <div class="flex justify-end gap-4 pt-4">
                            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Adjust Points</button>
                        </div>
                    </form>
                `;
                showModal(modalHTML);
                $('loyalty-form').onsubmit = this.saveLoyaltyAdjustment;
            },

            async saveLoyaltyAdjustment(e) {
                e.preventDefault();
                const formData = new FormData(e.target);
                const customerId = formData.get('id');
                const adjustment = parseInt(formData.get('adjustment'));

                if (isNaN(adjustment)) {
                    return renderError("Invalid number for points.");
                }

                try {
                    const { data, error } = await supabase.rpc('adjust_loyalty_points', { customer_id_input: customerId, points_change: adjustment });
                    if (error) throw error;
                    
                    showToast('Loyalty points adjusted!');
                    closeModal();
                } catch (e) {
                    renderError(`Error adjusting points: ${e.message}`);
                }
            },

            // --- DELETE ACTIONS ---
            async deleteCustomer(customerId, customerName) {
                if (confirm(`Are you sure you want to delete ${customerName} (ID: ${customerId})?\nTHIS ACTION CANNOT BE UNDONE.`)) {
                    try {
                        const { error } = await supabase.from('customers').delete().eq('id', customerId);
                        if (error) throw error;
                        
                        showToast('Customer deleted.');
                    } catch (e) {
                         renderError(`Error deleting customer: ${e.message}. (Note: Cannot delete customers with existing orders)`);
                    }
                }
            },

            async deleteOrder(orderId, customerName) {
                if (confirm(`Are you sure you want to delete this order from ${customerName} (ID: ${orderId})?\nThis will also delete all associated order items.\nTHIS ACTION CANNOT BE UNDONE.`)) {
                    try {
                        const { error } = await supabase.from('orders').delete().eq('id', orderId);
                        if (error) throw error;
                        
                        showToast('Order deleted.');
                    } catch (e) {
                         renderError(`Error deleting order: ${e.message}.`);
                    }
                }
            },
            
            // --- NEW ACTIONS ---
            async saveSetting(key) {
                const input = $(`setting-${key}`);
                const value = input.value;
                
                try {
                    const { error } = await supabase.from('app_settings').update({ value }).eq('key', key);
                    if (error) throw error;
                    showToast('Setting saved!');
                } catch (e) {
                    renderError(`Error saving setting: ${e.message}`);
                }
            },
            
            // --- NEW HELPER for modal content ---
            generateNewOrderModalHTML(order) {
                const items = order.order_items || [];
                const discount = order.discount_amount || 0;
                const points = order.discount_points_redeemed || 0;
                
                return `
                    <div class="text-center">
                        <h1 class="text-4xl font-bold text-yellow-500 mb-4 animate-pulse">!! NEW ORDER !!</h1>
                        <h2 class="text-3xl font-bold">Table #${order.tables?.table_number || 'N/A'}</h2>
                        <p class="text-xl text-gray-600 mb-6">By: ${order.customers?.name || 'Guest'}</p>
                        
                        <div class="text-left my-4 border-y border-gray-200 py-4 max-h-40 overflow-y-auto">
                            <h3 class="font-bold text-lg mb-2">Items:</h3>
                            ${items.length > 0 ? `
                                <ul class="space-y-1 list-decimal list-inside">
                                    ${items.map(item => `<li><span class="font-semibold">${item.products?.name || 'Item'}</span> x${item.quantity}</li>`).join('')}
                                </ul>
                            ` : `
                                <p class="text-gray-500 text-center">Loading items...</p>
                            `}
                            ${order.special_instructions ? `<p class="mt-3 text-sm italic text-yellow-800 bg-yellow-100 p-2 rounded-md"><strong>Note:</strong> ${order.special_instructions}</p>` : ''}
                        </div>

                        ${discount > 0 ? `
                        <div class="text-left my-4 bg-green-100 border border-green-300 p-3 rounded-lg">
                            <h3 class="font-bold text-lg text-green-800">Discount Applied!</h3>
                            <p class="text-green-700">Customer redeemed <span class="font-bold">${points} points</span> for a <span class="font-bold">â‚¹${discount.toFixed(2)} discount</span>.</p>
                        </div>
                        ` : ''}

                        <div class="flex gap-4 mt-8">
                            <button class="btn btn-success flex-1 py-4 text-lg" onclick="actions.acceptOrderFromModal('${order.id}')">
                                Accept Order
                            </button>
                            <button class="btn btn-danger flex-1 py-4 text-lg" onclick="actions.cancelOrderFromModal('${order.id}')">
                                Cancel Order
                            </button>
                        </div>
                    </div>
                `;
            },
            
            // --- NEW MODAL ACTIONS for blocking order screen ---
            showNewOrderModal(order) {
                // DO NOT SHOW MODAL if user is already on the kitchen screen
                if ($('live-kitchen-tab').classList.contains('active')) {
                    return;
                }

                // Get HTML from helper
                const modalInnerHTML = this.generateNewOrderModalHTML(order);
                const modalHTML = `<div id="new-order-modal-${order.id}">${modalInnerHTML}</div>`;
                showBlockingModal(modalHTML);
            },

            async acceptOrderFromModal(orderId) {
                closeModal();
                await this.updateOrderStatus(orderId, 'preparing');
            },

            async cancelOrderFromModal(orderId) {
                closeModal();
                await this.updateOrderStatus(orderId, 'cancelled');
            },

            // --- CSV EXPORT ACTIONS ---
            exportOrderHistoryCSV() {
                const headers = ["Order ID", "Date", "Customer", "Table", "Status", "Subtotal", "Discount", "GST", "Final Total", "Items"];
                const rows = state.pastOrders.map(order => {
                    const items = (order.order_items || []).map(i => `${i.products?.name || 'Item'} (x${i.quantity})`).join(' | ');
                    
                    let orderSubtotal = (order.order_items || []).reduce((sum, item) => sum + (item.price_at_time_of_order * item.quantity), 0);
                    const discount = order.discount_amount || 0;
                    const finalTotal = order.final_amount || 0;
                    const gst = finalTotal - (orderSubtotal - discount); // More accurate GST
                    
                    return [
                        order.id,
                        new Date(order.created_at).toLocaleString(),
                        order.customers?.name || 'Guest',
                        order.tables?.table_number || 'N/A',
                        order.status,
                        orderSubtotal.toFixed(2),
                        discount.toFixed(2),
                        gst.toFixed(2),
                        finalTotal.toFixed(2),
                        `"${items}"` // Enclose items in quotes
                    ].join(',');
                });
                
                this.downloadCSV([headers.join(','), ...rows].join('\n'), 'order-history.csv');
            },
            
            exportCustomerListCSV() {
                const headers = ["ID", "Name", "Phone", "Loyalty Points"];
                const rows = state.customers.map(cust => {
                    return [
                        cust.id,
                        `"${cust.name}"`,
                        cust.whatsapp_number || '',
                        cust.loyalty_points || 0
                    ].join(',');
                });
                
                this.downloadCSV([headers.join(','), ...rows].join('\n'), 'customer-list.csv');
            },
            
            exportMenuCSV() {
                const headers = ["ID", "Name", "Price", "Category", "Brand", "Is Available"];
                const rows = state.menu.map(item => {
                    return [
                        item.id,
                        `"${item.name}"`,
                        item.price,
                        item.category,
                        item.brand,
                        item.is_available
                    ].join(',');
                });
                
                this.downloadCSV([headers.join(','), ...rows].join('\n'), 'menu.csv');
            },
            
            downloadCSV(csvContent, fileName) {
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', fileName);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showToast(`Report "${fileName}" downloaded.`);
            }
        };

        // --- REAL-TIME LISTENERS ---
        const listeners = {
            startAll() {
                this.startKitchenListener(); // Renamed
                this.startMainOrderListener(); // New
                this.startCallListener();
                this.startMenuListener();
                this.startCustomerListener();
                this.startTableListener();
                this.startSettingsListener();
            },
            
            stopAll() {
                if (state.kitchenOrderSubscription) supabase.removeChannel(state.kitchenOrderSubscription);
                if (state.mainOrderSubscription) supabase.removeChannel(state.mainOrderSubscription);
                if (state.callSubscription) supabase.removeChannel(state.callSubscription);
                if (state.menuSubscription) supabase.removeChannel(state.menuSubscription);
                if (state.customerSubscription) supabase.removeChannel(state.customerSubscription);
                if (state.tableSubscription) supabase.removeChannel(state.tableSubscription);
                if (state.settingsSubscription) supabase.removeChannel(state.settingsSubscription);
            },
            
            // This listener ONLY updates the Live Kitchen tab
            startKitchenListener() {
                if (state.kitchenOrderSubscription) return;
                // FIX: Removed 'ready' from filter
                state.kitchenOrderSubscription = supabase.channel('public:orders:kitchen')
                    .on('postgres_changes', { 
                        event: '*', 
                        schema: 'public', 
                        table: 'orders',
                        filter: 'status=in.("received","preparing")' // Only listen for kitchen statuses
                    }, async (payload) => {
                        console.log('Kitchen change received:', payload);
                        
                        // On ANY change (INSERT, UPDATE, DELETE) in kitchen statuses,
                        // just reload all kitchen orders. This is the simplest,
                        // most robust way to ensure the columns are correct.
                        
                        // FIX: Removed 'ready' from query
                        const { data, error } = await supabase.from('orders')
                            .select('*, tables(table_number), customers(name), order_items(*, products(name))')
                            .in('status', ['received', 'preparing'])
                            .order('created_at', { ascending: true });
                        
                        if (error) {
                            renderError("Error refreshing kitchen: " + error.message);
                            return;
                        }
                        
                        state.kitchenOrders = data;
                        render.liveKitchen(); // Re-render the whole kitchen view

                        // If it's a new order, pop the modal (if not on kitchen tab)
                        if (payload.eventType === 'INSERT' && payload.new.status === 'received') {
                            playNotification();
                            // Fetch the full order data for the modal
                            const newOrderData = state.kitchenOrders.find(o => o.id === payload.new.id);
                            if(newOrderData) {
                                actions.showNewOrderModal(newOrderData);
                            }
                        }
                    })
                    .subscribe();
            },
            
            // This NEW listener handles changes for Analytics, History, and Dashboard stats
            startMainOrderListener() {
                if (state.mainOrderSubscription) return;
                state.mainOrderSubscription = supabase.channel('public:orders:main')
                    .on('postgres_changes', {
                        event: '*',
                        schema: 'public',
                        table: 'orders'
                    }, async (payload) => {
                        console.log('Main order change received:', payload);
                        
                        const orderId = payload.new?.id || payload.old?.id;
                        const newStatus = payload.new?.status;
                        const oldStatus = payload.old?.status;
                        
                        // --- Update History Tab ---
                        if (payload.eventType === 'INSERT' && (newStatus === 'cancelled' || newStatus === 'delivered')) {
                            // A new order was created *already* as finished (rare, but possible)
                            const newOrderData = await fetchOrderDetails(orderId);
                            if (newOrderData) state.pastOrders.unshift(newOrderData);
                            render.history();
                        }
                        else if (payload.eventType === 'UPDATE' && (newStatus === 'cancelled' || newStatus === 'delivered')) {
                            // An order was just finished, add it to history
                            const newOrderData = await fetchOrderDetails(orderId);
                            if (newOrderData) {
                                // Remove from list if it was already there (e.g., cancelled -> delivered)
                                state.pastOrders = state.pastOrders.filter(o => o.id !== orderId);
                                state.pastOrders.unshift(newOrderData);
                            }
                            render.history();
                        }
                        else if (payload.eventType === 'DELETE') {
                            state.pastOrders = state.pastOrders.filter(o => o.id !== orderId);
                            render.history();
                        }
                        
                        // --- Update Dashboard & Analytics ---
                        // If an order becomes 'delivered' OR an old 'delivered' order is modified
                        if (newStatus === 'delivered' || oldStatus === 'delivered') {
                            await dataHelpers.loadDashboardStats(); // Recalculate stats for today
                            render.analytics(); // Re-render analytics
                        }
                    })
                    .subscribe();
            },

            startCallListener() {
                if (state.callSubscription) return;
                state.callSubscription = supabase.channel('public:staff_calls')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'staff_calls' }, (payload) => {
                        console.log('Staff call change received:', payload);
                        
                        const callId = payload.new?.id || payload.old?.id;
                        const newStatus = payload.new?.status;

                        if (payload.eventType === 'INSERT' && newStatus === 'pending') {
                            state.staffCalls.push(payload.new);
                            playNotification();
                        }
                        else if (payload.eventType === 'UPDATE') {
                            const index = state.staffCalls.findIndex(c => c.id === callId);
                            if (newStatus !== 'pending' && index > -1) {
                                state.staffCalls.splice(index, 1);
                            } else if (newStatus === 'pending' && index === -1) {
                                state.staffCalls.push(payload.new);
                            }
                        }
                        else if (payload.eventType === 'DELETE') {
                            const index = state.staffCalls.findIndex(c => c.id === callId);
                            if (index > -1) state.staffCalls.splice(index, 1);
                        }
                        render.staffCalls(); // Only re-render calls
                    })
                    .subscribe();
            },
            
            startMenuListener() {
                if (state.menuSubscription) return;
                state.menuSubscription = supabase.channel('public:products')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'products' }, (payload) => {
                        console.log('Menu change received:', payload);
                        const itemId = payload.new?.id || payload.old?.id;
                        
                        if (payload.eventType === 'INSERT') {
                            state.menu.push(payload.new);
                        }
                        else if (payload.eventType === 'UPDATE') {
                            const index = state.menu.findIndex(i => i.id === itemId);
                            if (index > -1) state.menu[index] = payload.new;
                        }
                        else if (payload.eventType === 'DELETE') {
                            state.menu = state.menu.filter(i => i.id !== itemId);
                        }
                        state.menu.sort((a, b) => a.name.localeCompare(b.name));
                        render.menu();
                    })
                    .subscribe();
            },

            startCustomerListener() {
                if (state.customerSubscription) return;
                state.customerSubscription = supabase.channel('public:customers')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'customers' }, (payload) => {
                        console.log('Customer change received:', payload);
                        const custId = payload.new?.id || payload.old?.id;

                        if (payload.eventType === 'INSERT') {
                            state.customers.push(payload.new);
                        }
                        else if (payload.eventType === 'UPDATE') {
                            const index = state.customers.findIndex(c => c.id === custId);
                            if (index > -1) state.customers[index] = payload.new;
                        }
                        else if (payload.eventType === 'DELETE') {
                            state.customers = state.customers.filter(c => c.id !== custId);
                        }
                        state.customers.sort((a, b) => a.name.localeCompare(b.name));
                        render.customers();
                    })
                    .subscribe();
            },
            
            startTableListener() {
                if (state.tableSubscription) return;
                state.tableSubscription = supabase.channel('public:tables')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'tables' }, (payload) => {
                        console.log('Table change received:', payload);
                        const tableId = payload.new?.id || payload.old?.id;

                        if (payload.eventType === 'INSERT') {
                            state.tables.push(payload.new);
                        }
                        else if (payload.eventType === 'UPDATE') {
                            const index = state.tables.findIndex(t => t.id === tableId);
                            if (index > -1) state.tables[index] = payload.new;
                        }
                        else if (payload.eventType === 'DELETE') {
                            state.tables = state.tables.filter(t => t.id !== tableId);
                        }
                        state.tables.sort((a, b) => a.table_number - b.table_number);
                        render.tables();
                    })
                    .subscribe();
            },
            
            startSettingsListener() {
                if (state.settingsSubscription) return;
                state.settingsSubscription = supabase.channel('public:app_settings')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'app_settings' }, (payload) => {
                        console.log('Settings change received:', payload);
                        const settingKey = payload.new?.key || payload.old?.key;
                        
                        if (payload.eventType === 'INSERT') {
                            state.appSettings.push(payload.new);
                        }
                        else if (payload.eventType === 'UPDATE') {
                            const index = state.appSettings.findIndex(s => s.key === settingKey);
                            if (index > -1) state.appSettings[index] = payload.new;
                        }
                        else if (payload.eventType === 'DELETE') {
                            state.appSettings = state.appSettings.filter(s => s.key !== settingKey);
                        }
                        state.appSettings.sort((a, b) => a.key.localeCompare(b.key));
                        render.settings();
                    })
                    .subscribe();
            }
        };

        // Helper to fetch full order details
        async function fetchOrderDetails(orderId) {
            try {
                const { data, error } = await supabase.from('orders')
                    .select('*, tables(table_number), customers(name), order_items(*, products(name))')
                    .eq('id', orderId)
                    .single();
                
                if (error) throw error;
                return data; // Just return the data
            } catch (e) {
                console.error("Failed to fetch order details:", e);
                return null; // Return null on failure
            }
        }


        // --- RENDERING ---
        const render = {
            all() {
                this.dashboard();
                this.liveKitchen();
                this.history();
                this.menu();
                this.customers();
                this.tables();
                this.qr();
                this.analytics();
                this.reports();
                this.settings();
            },

            // NEW: Renders the stats dashboard
            dashboard() {
                const statsContainer = $('stats-container');
                if (!statsContainer) return;
                
                const { gross, net, count } = state.dashboardStats;
                statsContainer.innerHTML = `
                    <div class="card p-6">
                        <h3 class="text-sm font-medium text-gray-500">Today's Gross Revenue</h3>
                        <p class="text-3xl font-bold text-gray-900 mt-1">â‚¹${gross.toFixed(2)}</p>
                    </div>
                    <div class="card p-6">
                        <h3 class="text-sm font-medium text-gray-500">Today's Net Revenue</h3>
                        <p class="text-3xl font-bold text-gray-900 mt-1">â‚¹${net.toFixed(2)}</p>
                    </div>
                    <div class="card p-6">
                        <h3 class="text-sm font-medium text-gray-500">Today's Delivered Orders</h3>
                        <p class="text-3xl font-bold text-gray-900 mt-1">${count}</p>
                    </div>
                `;
                
                this.staffCalls();
            },
            
            // NEW: Renders only staff calls
            staffCalls() {
                const callsContainer = $('staff-calls-container');
                const noCallsMsg = $('no-calls-msg');
                if (!callsContainer || !noCallsMsg) return;
                
                if (state.staffCalls.length === 0) {
                    callsContainer.innerHTML = '';
                    noCallsMsg.classList.remove('hidden');
                } else {
                    noCallsMsg.classList.add('hidden');
                    state.staffCalls.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                    
                    callsContainer.innerHTML = state.staffCalls.map(call => {
                        const time = new Date(call.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        return `
                            <div class="card p-4 call-card-new border-2 border-red-500">
                                <div class="flex justify-between items-center mb-2">
                                    <h3 class="text-xl font-bold">Table #${call.table_number}</h3>
                                    <span class="text-sm text-gray-500">${time}</span>
                                </div>
                                <p class="text-lg text-red-700 font-semibold capitalize mb-3">${call.call_type === 'payment' ? 'Needs Payment' : 'Needs Assistance'}</p>
                                <button class="btn btn-danger w-full" onclick="actions.resolveStaffCall('${call.id}')">
                                    Resolve
                                </button>
                            </div>
                        `;
                    }).join('');
                }
            },

            // NEW: Renders the 3-column kitchen view
            liveKitchen() {
                const colReceived = $('kitchen-col-received');
                const colPreparing = $('kitchen-col-preparing');
                // FIX: Removed ready column
                const noOrdersMsg = $('no-orders-msg');
                
                if (!colReceived) return; // Tab not active
                
                // Clear columns
                colReceived.innerHTML = '';
                colPreparing.innerHTML = '';
                // FIX: Removed ready column
                
                const received = state.kitchenOrders.filter(o => o.status === 'received');
                const preparing = state.kitchenOrders.filter(o => o.status === 'preparing');
                // FIX: Removed ready filter
                
                // FIX: Updated condition
                if (received.length === 0 && preparing.length === 0) {
                    noOrdersMsg.classList.remove('hidden');
                    colReceived.appendChild(noOrdersMsg);
                } else {
                    if (noOrdersMsg) noOrdersMsg.classList.add('hidden');
                }
                
                // Render Received
                received.forEach(order => colReceived.appendChild(this.createKitchenCard(order, 'received')));
                // Render Preparing
                preparing.forEach(order => colPreparing.appendChild(this.createKitchenCard(order, 'preparing')));
                // FIX: Removed ready render
            },
            
            // NEW: Helper to create a kitchen card
            createKitchenCard(order, status) {
                const card = document.createElement('div');
                card.className = `card p-4 ${status === 'received' ? 'order-card-new border-2 border-yellow-500' : ''}`;
                
                const items = order.order_items || [];
                const time = new Date(order.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                // FIX: Updated button logic
                let buttonHTML = '';
                if (status === 'received') {
                    buttonHTML = `<button class="btn btn-primary w-full" onclick="actions.updateOrderStatus('${order.id}', 'preparing')">Start Preparing</button>`;
                } else if (status === 'preparing') {
                    buttonHTML = `<button class="btn btn-success w-full" onclick="actions.updateOrderStatus('${order.id}', 'delivered')">Mark as Delivered</button>`;
                }
                // FIX: Removed 'ready' status button

                card.innerHTML = `
                    <div class="flex justify-between items-center mb-3">
                        <div>
                            <h3 class="text-xl font-bold">Table #${order.tables?.table_number || 'N/A'}</h3>
                            <p class="text-gray-600">by ${order.customers?.name || 'Guest'} at ${time}</p>
                        </div>
                        <button class="btn btn-secondary btn-sm" onclick="actions.updateOrderStatus('${order.id}', 'cancelled')">
                            Cancel
                        </button>
                    </div>
                    <div class="border-t border-gray-100 pt-3 mb-4 max-h-40 overflow-y-auto">
                        <ul class="space-y-1">
                            ${items.map(item => `
                                <li class="flex justify-between">
                                    <span class="text-gray-800">${item.products?.name || 'Item'}</span>
                                    <span class="font-medium text-gray-600">x${item.quantity}</span>
                                </li>
                            `).join('')}
                        </ul>
                        ${order.special_instructions ? `
                            <p class="mt-3 text-sm italic text-yellow-800 bg-yellow-100 p-2 rounded-md">
                                <strong>Note:</strong> ${order.special_instructions}
                            </p>
                        ` : ''}
                    </div>
                    <div class="flex gap-2">
                        ${buttonHTML}
                    </div>
                `;
                return card;
            },

            history() {
                const historyBody = $('history-table-body');
                if (!historyBody) return; // Tab not active
                
                if (state.pastOrders.length === 0) {
                    historyBody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500">No past orders found.</td></tr>';
                    return;
                }
                
                // Sort by date, newest first
                state.pastOrders.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                
                historyBody.innerHTML = state.pastOrders.map(order => {
                    const time = new Date(order.created_at).toLocaleString();
                    const statusColor = order.status === 'delivered' ? 'text-green-600' : 'text-red-600';
                    return `
                        <tr class="border-b border-gray-100 hover:bg-gray-50">
                            <td class="p-2">${time}</td>
                            <td class="p-2">${order.customers?.name || 'Guest'}</td>
                            <td class="p-2">${order.tables?.table_number || 'N/A'}</td>
                            <td class="p-2">â‚¹${(order.final_amount || 0).toFixed(2)}</td>
                            <td class="p-2 font-semibold ${statusColor} capitalize">${order.status}</td>
                            <td class="p-2 text-right">
                                <button class="btn btn-danger btn-sm" onclick="actions.deleteOrder('${order.id}', '${order.customers?.name || 'Guest'}')">
                                    Delete
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            },

            menu() {
                const menuBody = $('menu-table-body');
                if (!menuBody) return; // Tab not active
                
                menuBody.innerHTML = state.menu.map(item => `
                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                        <td class="p-2">${item.name}</td>
                        <td class="p-2">â‚¹${item.price}</td>
                        <td class="p-2">${item.category}</td>
                        <td class="p-2">${item.brand}</td>
                        <td class="p-2">
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" ${item.is_available ? 'checked' : ''} class="sr-only peer" onchange="actions.toggleItemAvailability('${item.id}', this.checked)">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                            </label>
                        </td>
                        <td class="p-2 text-right">
                            <button class="btn btn-secondary btn-sm" onclick="actions.showMenuModal('${item.id}')">Edit</button>
                        </td>
                    </tr>
                `).join('');
            },

            customers() {
                const customersBody = $('customers-table-body');
                if (!customersBody) return; // Tab not active
                
                customersBody.innerHTML = state.customers.map(cust => `
                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                        <td class="p-2">${cust.name}</td>
                        <td class="p-2">${cust.whatsapp_number || 'N/A'}</td>
                        <td class="p-2">${cust.loyalty_points || 0}</td>
                        <td class="p-2 text-right space-x-2">
                            <button class="btn btn-secondary btn-sm" onclick="actions.showLoyaltyModal('${cust.id}', '${cust.name}', ${cust.loyalty_points || 0})">Adjust Points</button>
                            <button class="btn btn-secondary btn-sm" onclick="actions.showCustomerModal('${cust.id}')">Edit</button>
                            <button class="btn btn-danger btn-sm" onclick="actions.deleteCustomer('${cust.id}', '${cust.name}')">Delete</button>
                        </td>
                    </tr>
                `).join('');
            },

            tables() {
                const tablesBody = $('tables-table-body');
                if (!tablesBody) return; // Tab not active
                
                tablesBody.innerHTML = state.tables.map(table => `
                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                        <td class="p-2 font-bold">${table.table_number}</td>
                        <td class="p-2">${table.description || 'N/A'}</td>
                        <td class="p-2 text-right">
                            <button class="btn btn-secondary btn-sm" onclick="actions.showTableModal('${table.id}')">Edit</button>
                        </td>
                    </tr>
                `).join('');
            },

            qr() {
                const container = $('qr-code-container');
                if (!container) return; // Tab not active
                
                const customerAppUrl = 'https://bulb-77jm.onrender.com/';
                container.innerHTML = ''; // Clear
                for (let i = 1; i <= 10; i++) {
                    const url = `${customerAppUrl}?table=${i}`;
                    const wrapper = document.createElement('div');
                    wrapper.className = 'card p-4 flex flex-col items-center';
                    
                    const canvas = document.createElement('canvas');
                    canvas.id = `qr-canvas-${i}`;
                    
                    const label = document.createElement('h3');
                    label.className = 'text-lg font-bold mt-3';
                    label.textContent = `Table ${i}`;
                    
                    wrapper.appendChild(canvas);
                    wrapper.appendChild(label);
                    container.appendChild(wrapper);
                    
                    new QRious({
                        element: canvas,
                        value: url,
                        size: 200,
                        padding: 10,
                        level: 'H'
                    });
                }
            },
            
            // NEW RENDER FUNCTIONS
            analytics() {
                const statsContainer = $('analytics-stats-container');
                const topItemsContainer = $('analytics-top-items-container');
                if (!statsContainer || !topItemsContainer) return; // Tab not active

                const deliveredOrders = state.pastOrders.filter(o => o.status === 'delivered');
                const totalRevenue = deliveredOrders.reduce((sum, order) => sum + (order.final_amount || 0), 0);
                const totalOrders = deliveredOrders.length;
                const avgOrderValue = totalOrders > 0 ? totalRevenue / totalOrders : 0;

                statsContainer.innerHTML = `
                    <div class="card p-6">
                        <h3 class="text-sm font-medium text-gray-500">Total Revenue</h3>
                        <p class="text-3xl font-bold text-gray-900 mt-1">â‚¹${totalRevenue.toFixed(2)}</p>
                    </div>
                    <div class="card p-6">
                        <h3 class="text-sm font-medium text-gray-500">Total Delivered Orders</h3>
                        <p class="text-3xl font-bold text-gray-900 mt-1">${totalOrders}</p>
                    </div>
                    <div class="card p-6">
                        <h3 class="text-sm font-medium text-gray-500">Avg. Order Value</h3>
                        <p class="text-3xl font-bold text-gray-900 mt-1">â‚¹${avgOrderValue.toFixed(2)}</p>
                    </div>
                `;

                const itemCounts = {};
                deliveredOrders.forEach(order => {
                    (order.order_items || []).forEach(item => {
                        const name = item.products?.name || 'Unknown Item';
                        itemCounts[name] = (itemCounts[name] || 0) + item.quantity;
                    });
                });
                
                const topItems = Object.entries(itemCounts)
                                     .sort(([,a], [,b]) => b - a)
                                     .slice(0, 5);
                
                if (topItems.length === 0) {
                    topItemsContainer.innerHTML = '<p class="text-gray-500">No item data from delivered orders yet.</p>';
                } else {
                    topItemsContainer.innerHTML = `
                        <ol class="list-decimal list-inside space-y-2">
                            ${topItems.map(([name, count]) => `
                                <li class="text-gray-700">
                                    <span class="font-semibold">${name}</span> (${count} sold)
                                </li>
                            `).join('')}
                        </ol>
                    `;
                }
            },
            
            reports() {
                // This tab is static HTML, no render logic needed
            },
            
            settings() {
                const container = $('settings-container');
                if (!container) return; // Tab not active

                if (state.appSettings.length === 0) {
                    container.innerHTML = '<p class="text-gray-500">No application settings found.</p>';
                    return;
                }
                
                container.innerHTML = state.appSettings.map(setting => `
                    <div class="flex flex-col md:flex-row md:items-center justify-between">
                        <div>
                            <label for="setting-${setting.key}" class="form-label capitalize">${setting.key.replace(/_/g, ' ')}</label>
                            <p class="text-sm text-gray-500 -mt-2 mb-2">Key: ${setting.key}</p>
                        </div>
                        <div class="flex gap-2 w-full md:w-auto">
                            <input type="text" id="setting-${setting.key}" class="form-input w-full md:w-40" value="${setting.value}">
                            <button class="btn btn-primary" onclick="actions.saveSetting('${setting.key}')">Save</button>
                        </div>
                    </div>
                `).join('');
            }
        };

        // --- GLOBAL MODAL CONTROLS ---
        function showModal(html) {
            const container = $('modal-container');
            container.innerHTML = `<div class="modal-overlay" onclick="closeModal()"><div class="modal-content" onclick="event.stopPropagation();">${html}</div></div>`;
            container.classList.remove('hidden');
        }
        function showBlockingModal(html) {
            const container = $('modal-container');
            container.innerHTML = `<div class="modal-overlay"><div class="modal-content" onclick="event.stopPropagation();">${html}</div></div>`;
            container.classList.remove('hidden');
        }
        function closeModal() {
            const container = $('modal-container');
            container.classList.add('hidden');
            container.innerHTML = '';
        }

        // --- GLOBAL EVENT BINDINGS ---
        $('login-form').onsubmit = (e) => {
            e.preventDefault();
            const email = $('email').value;
            const password = $('password').value;
            auth.login(email, password);
        };

        $$('#logout-button').forEach(btn => btn.onclick = () => auth.logout());

        $('nav-links').onclick = (e) => {
            const navLink = e.target.closest('.nav-link');
            if (navLink) {
                const tab = navLink.dataset.tab;
                
                $$('.nav-link').forEach(link => link.classList.remove('active'));
                navLink.classList.add('active');
                
                $$('.tab-content').forEach(content => content.classList.remove('active'));
                $(`${tab}-tab`).classList.add('active');
                
                // Re-render tabs that depend on data
                if (tab === 'analytics') {
                    render.analytics();
                } else if (tab === 'dashboard') {
                    render.dashboard();
                } else if (tab === 'live-kitchen') {
                    render.liveKitchen();
                }
            }
        };

        $('add-item-btn').onclick = () => actions.showMenuModal();
        $('add-table-btn').onclick = () => actions.showTableModal();

        // Make actions globally accessible for inline onclicks
        window.actions = actions;
        window.closeModal = closeModal;
    </script>
</body>
</html>

